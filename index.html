<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>COFFEE ROYALE ‚Äî MENU 69 / 71</title>

  <style>
    /* ==========================================================
       COFFEE ROYALE ‚Äî Resin Texture Luxe Brut (DESIGN)
       - Rubriques / IDs / logique : conserv√©s
       - Mot "CBD" : absent
       ========================================================== */

    :root{
      --bg0:#050403;
      --bg1:#0b0806;
      --glass: rgba(10, 8, 6, 0.64);
      --stroke: rgba(255,255,255,0.14);
      --stroke2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.76);

      --resin:#b8895a;
      --resinDeep:#6e3f24;
      --ember:#ffcc66;
      --leaf:#33e06f;

      --radius:18px;
      --shadow: 0 14px 46px rgba(0,0,0,0.55);
      --shadowSoft: 0 10px 30px rgba(0,0,0,0.40);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 780px at 14% -10%, rgba(51,224,111,0.10), transparent 56%),
        radial-gradient(1000px 740px at 110% 12%, rgba(184,137,90,0.14), transparent 58%),
        radial-gradient(900px 650px at 40% 120%, rgba(110,63,36,0.14), transparent 58%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, #070605),
        url('IMG_7404.jpeg') no-repeat center center fixed;
      background-size: cover;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:0.16;
      mix-blend-mode: overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.82' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
    }

    .overlay{
      min-height:100vh;
      background: rgba(0,0,0,0.68);
      padding: 16px 14px 28px;
      max-width: 820px;
      margin: 0 auto;
    }

    h1{
      margin: 10px 0 4px;
      letter-spacing: 3px;
      text-align:center;
      font-weight: 1000;
      text-transform: uppercase;
      text-shadow: 0 0 26px rgba(184,137,90,0.15);
    }

    .brandSub{
      text-align:center;
      font-weight: 1000;
      letter-spacing: 3px;
      margin: 0 0 10px;
      text-transform: uppercase;
      opacity: 0.92;
      color: rgba(255,255,255,0.90);
    }

    .sub{
      opacity:.88;
      font-size:13px;
      text-align:center;
      margin-bottom: 10px;
      color: var(--muted);
    }

    .card{
      position:relative;
      background: var(--glass);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 12px;
      margin: 12px 0;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      left:12px; right:12px; top:10px;
      height:3px;
      border-radius:999px;
      opacity:.62;
      background: linear-gradient(90deg,
        transparent,
        rgba(51,224,111,0.70),
        rgba(184,137,90,0.85),
        rgba(110,63,36,0.70),
        transparent
      );
      pointer-events:none;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}

    .btn{
      width:100%;
      border:none;
      padding:14px 12px;
      margin: 8px 0;
      font-size:18px;
      color:#080604;
      border-radius:16px;
      cursor:pointer;
      font-weight:1000;
      background:
        linear-gradient(135deg, rgba(51,224,111,0.90), rgba(184,137,90,0.92)),
        radial-gradient(700px 140px at 50% 0%, rgba(255,255,255,0.22), transparent 60%);
      box-shadow: 0 14px 34px rgba(0,0,0,0.40), 0 0 28px rgba(184,137,90,0.10);
      transition: transform .08s ease, filter .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }

    .btn.secondary{
      color: var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border:1px solid rgba(255,255,255,0.16);
      box-shadow:none;
    }
    .btn.ghost{
      color: var(--text);
      background: transparent;
      border:1px solid rgba(255,255,255,0.16);
      box-shadow:none;
    }
    .btn.small{font-size:14px; padding:10px 12px; width:auto}

    .pill{
      background: rgba(255,255,255,0.07);
      border:1px solid rgba(255,255,255,0.16);
      padding: 10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:1000;
      font-size:13px;
      user-select:none;
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .pill:active{ transform: translateY(1px) scale(.99); }
    .pill.active{
      background: linear-gradient(135deg, rgba(51,224,111,0.18), rgba(184,137,90,0.14));
      border-color: rgba(184,137,90,0.35);
      box-shadow: 0 0 0 2px rgba(184,137,90,0.10), 0 0 28px rgba(184,137,90,0.12);
    }

    .muted{opacity:.86; font-size:13px; color: var(--muted);}
    .divider{height:1px; background: rgba(255,255,255,0.12); margin: 10px 0}

    .item{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .item:last-child{border-bottom:none}
    .name{font-weight:1000}
    .price{opacity:.94; font-weight:1000; color: rgba(255,204,102,0.95);}

    .qty{display:flex; align-items:center; gap:8px}
    .qbtn{
      width:36px; height:36px; border-radius:12px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff; font-weight:1000; font-size:18px;
      cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
    }
    .qnum{min-width:18px; text-align:center; font-weight:1000}

    textarea, input, select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.32);
      color:#fff;
      padding:12px;
      font-size:14px;
      outline:none;
      margin-top:6px;
    }
    textarea:focus, input:focus, select:focus{
      border-color: rgba(184,137,90,0.40);
      box-shadow: 0 0 0 3px rgba(184,137,90,0.12);
    }

    .sumrow{
      display:flex; justify-content:space-between; align-items:center;
      padding:6px 0;
    }
    .sumrow strong{font-size:16px}
    .total strong{font-size:20px}

    .hidden{display:none}
    .center{text-align:center}
    .tiny{font-size:12px; opacity:.78}
    .tag{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(184,137,90,0.30);
      background: rgba(184,137,90,0.10);
      font-weight:1000;
      font-size:12px;
    }

    .disabled{
      opacity:.45;
      filter: grayscale(1);
      cursor:not-allowed !important;
      pointer-events:none;
    }
    .badge{
      display:inline-block;
      margin-left:8px;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:1000;
      background:rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.16);
    }

    .rouletteWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin-top:10px;
    }
    canvas{
      max-width:100%;
      border-radius:16px;
      background: rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.15);
      box-shadow: var(--shadowSoft);
    }
    .gainList{
      text-align:left;
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(255,255,255,0.07);
      border:1px solid rgba(255,255,255,0.14);
    }
    .gainList ul{margin:8px 0 0 18px; padding:0}
    .okBox{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(184,137,90,0.10);
      border:1px solid rgba(184,137,90,0.28);
      box-shadow: var(--shadowSoft);
    }

    .plate{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.14);
    }
    .plateTitle{font-weight:1000; margin-bottom:8px}
    .passageRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .passageRow:last-child{border-bottom:none}
    .timeTag{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(184,137,90,0.28);
      background: rgba(184,137,90,0.10);
      font-weight:1000;
      font-size:12px;
      color: rgba(255,255,255,0.92);
    }

    .btn:focus-visible, .pill:focus-visible, .qbtn:focus-visible, input:focus-visible, textarea:focus-visible, select:focus-visible{
      outline: 2px solid rgba(184,137,90,0.55);
      outline-offset: 2px;
    }
  </style>
</head>

<body>
<div class="overlay">
  <h1>MENU</h1>
  <div class="brandSub">COFFEE ROYALE</div>
  <div class="sub">Paiement : main propre ‚Ä¢ Frais distance : 10‚Ç¨ / 15km (calcul vendeur)</div>

  <!-- HOME -->
  <div class="card" id="home">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Accueil</div>
    <button class="btn" onclick="go('stepSector')">Commander</button>
    <button class="btn secondary" onclick="go('wheel')">üé∞ Roue (1 fois / semaine)</button>
    <button class="btn secondary" onclick="go('referral')">Programme Partenaire</button>
    <button class="btn secondary" onclick="go('contest')">Concours Cr√©ateur</button>
    <button class="btn secondary disabled">üì¶ Envoi postal France <span class="badge">Bient√¥t disponible</span></button>
    <button class="btn secondary" onclick="go('apply')">Postuler</button>
    <button class="btn secondary" onclick="go('support')">Service Client</button>
    <button class="btn secondary" onclick="shareSite()">Partager ce site</button>

    <div class="divider"></div>
    <div class="muted">
      <b>Important :</b> Les frais distance (10‚Ç¨ / 15km) sont calcul√©s par le vendeur.<br/>
      <span class="tiny">La direction se r√©serve le droit d‚Äôajouter des frais en fonction des kilom√®tres.</span>
    </div>
  </div>

  <!-- STEP SECTOR -->
  <div class="card hidden" id="stepSector">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Choisis</div>

    <button class="btn" onclick="selectSector('69')">69 ‚Äî Villefranche (Sur place / Livraison)</button>

    <div class="divider"></div>
    <div class="muted center" style="margin-bottom:6px;"><b>71</b></div>

    <button class="btn" onclick="quick71Pickup('M√¢con')">71 ‚Äî Sur place : M√¢con</button>
    <button class="btn" onclick="quick71Pickup('Tournus')">71 ‚Äî Sur place : Tournus</button>
    <button class="btn" onclick="quick71Delivery()">71 ‚Äî Livraison (tourn√©es)</button>

    <div class="muted center" style="margin-top:10px;">
      Sur place : 07:00 ‚Üí 00:00<br/>
      69 livraison : 16h / 19h / 21h30 (+60‚Ç¨ hors tourn√©e) ‚Ä¢ 71 livraison : 16h / 19h / 21h30 (+60‚Ç¨ hors tourn√©e)
    </div>

    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- STEP RUBRIC -->
  <div class="card hidden" id="stepRubric">
    <div class="center" style="font-weight:900; margin-bottom:8px;" id="rubricTitle">Choisis la rubrique</div>
    <div class="row">
      <div class="pill" id="pillPickup" onclick="selectMode('pickup')">üè¢ Sur place</div>
      <div class="pill" id="pillDelivery" onclick="selectMode('delivery')">üöò Livraison</div>
      <div class="pill disabled" id="pillPostal">üì¶ Envoi postal <span class="badge">Bient√¥t disponible</span></div>
    </div>
    <div class="muted center" id="rubricInfo" style="margin-top:10px;"></div>
    <button class="btn ghost" onclick="go('stepSector')">‚Üê Retour</button>
  </div>

  <!-- DELIVERY OPTIONS -->
  <div class="card hidden" id="stepDeliveryOptions">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Livraison</div>
       
    <div id="delivery71Tours" class="hidden">
      <div class="okBox" style="margin-bottom:10px;">
        <div style="font-weight:900;">üïí Prochaine tourn√©e : <span id="nextTourLabel">‚Äî</span></div>
        <div class="muted">D√©part dans : <span id="nextTourCountdown">‚Äî</span></div>
      </div>

      <div class="muted" style="margin-bottom:8px;">
        Tourn√©es <b>16:00</b> / <b>19:00</b> / <b>21:30</b><br/>
        Option <b>hors tourn√©e / hors horaires</b> : +60‚Ç¨
      </div>

      <div class="row">
        <div class="pill" id="tour16" onclick="selectTour('16:00')">16:00</div>
        <div class="pill" id="tour19" onclick="selectTour('19:00')">19:00</div>
        <div class="pill" id="tour2130" onclick="selectTour('21:30')">21:30</div>
      </div>

      <div style="margin-top:10px;">
        <div class="pill" id="premiumPill" onclick="togglePremium()">‚òÖ Hors tourn√©e +60‚Ç¨</div>
      </div>

      <div id="delivery69Passage" class="plate hidden" style="margin-top:10px;">
        <div class="plateTitle">Heures de passage (exemples)</div>

        <div class="passageRow">
          <div class="muted">Belleville</div>
          <div class="timeTag">16:00</div>
        </div>
        <div class="passageRow">
          <div class="muted">Villefranche & alentours</div>
          <div class="timeTag">Toute la journ√©e</div>
        </div>
        <div class="passageRow">
          <div class="muted">Autres communes</div>
          <div class="timeTag">16:00 / 19:00 / 21:30</div>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
      </div>
    </div>

    <div class="divider"></div>

    <label class="muted">Adresse (obligatoire en livraison)</label>
    <textarea id="address" rows="3" placeholder="Adresse compl√®te + infos (√©tage, code...)"></textarea>

    <label class="muted" style="display:block; margin-top:10px;">Note (optionnel)</label>
    <input id="note" placeholder="Ex: heure souhait√©e, d√©tails..." />

    <div class="muted" style="margin-top:10px;">
      Frais distance : <b>10‚Ç¨ / 15km</b> (calcul vendeur).<br/>
    </div>

    <button class="btn" onclick="goToMenu()">Continuer</button>
    <button class="btn ghost" onclick="backToRubric()">‚Üê Retour</button>
  </div>

  <!-- MENU -->
  <div class="card hidden" id="stepMenu">
    <div class="center" style="font-weight:900; margin-bottom:8px;" id="menuTitle">Menu</div>

    <div class="row" id="categoryRow"></div>
    <div class="divider"></div>
    <div id="itemsList"></div>
    <div class="divider"></div>

    <label class="muted">Code parrain (optionnel)</label>
    <input id="referrerCode" placeholder="Ex: REF-AB12CD" />

    <div class="sumrow"><span>Sous-total</span><strong id="subtotal">0‚Ç¨</strong></div>
    <div class="sumrow hidden" id="premiumRow"><span>Hors tourn√©e</span><strong>+60‚Ç¨</strong></div>
    <div class="sumrow"><span>Frais distance</span><strong class="muted">√† ajouter (vendeur)</strong></div>
    <div class="sumrow total"><span>TOTAL (hors distance)</span><strong id="total">0‚Ç¨</strong></div>

    <div class="muted" style="margin-top:8px;">Paiement : main propre.</div>

    <button class="btn" onclick="goToSummary()">COMMANDER</button>
    <button class="btn secondary" onclick="clearCart()">Vider panier</button>
    <button class="btn ghost" onclick="backFromMenu()">‚Üê Retour</button>
  </div>

  <!-- SUMMARY -->
  <div class="card hidden" id="stepSummary">
    <div class="center" style="font-weight:900; margin-bottom:8px;">‚úÖ R√©capitulatif</div>
    <div class="muted center" style="margin-bottom:10px;">V√©rifie tout, puis confirme pour envoyer sur WhatsApp.</div>

    <div class="divider"></div>

    <div class="sumrow"><span><span class="tag">ID</span></span><strong id="sumOrderId">‚Äî</strong></div>
    <div class="sumrow"><span>Secteur</span><strong id="sumSector">‚Äî</strong></div>
    <div class="sumrow"><span>Mode</span><strong id="sumMode">‚Äî</strong></div>
    <div class="sumrow" id="sumPickupCityRow" style="display:none;"><span>Ville</span><strong id="sumPickupCity">‚Äî</strong></div>

    <div id="sumDeliveryBlock" class="hidden">
      <div class="divider"></div>
      <div class="sumrow"><span>Adresse</span><strong class="muted" id="sumAddress">‚Äî</strong></div>
      <div class="sumrow"><span>Note</span><strong class="muted" id="sumNote">‚Äî</strong></div>
      <div class="sumrow" id="sumTourRow"><span>Tourn√©e</span><strong id="sumTour">‚Äî</strong></div>
      <div class="sumrow" id="sumPremiumRow"><span>Hors tourn√©e</span><strong>+60‚Ç¨</strong></div>
    </div>

    <div class="divider"></div>
    <div id="sumItems"></div>
    <div class="divider"></div>

    <div class="sumrow"><span>Sous-total</span><strong id="sumSubtotal">0‚Ç¨</strong></div>
    <div class="sumrow" id="sumPremiumFeeRow"><span>Hors tourn√©e</span><strong id="sumPremiumFee">0‚Ç¨</strong></div>
    <div class="sumrow"><span>TOTAL (hors distance)</span><strong id="sumTotal">0‚Ç¨</strong></div>

    <div class="divider"></div>
    <div class="muted">
      <b>üé∞ Roue :</b> gain valable uniquement apr√®s validation r√©elle du livreur.<br/>
      <span class="tiny">Sans validation, aucun gain ne sera pris en compte.</span>
    </div>

    <button class="btn" onclick="confirmToWhatsApp()">Confirmer & Envoyer WhatsApp</button>
    <button class="btn ghost" onclick="go('stepMenu')">‚Üê Modifier</button>
  </div>

  <!-- WHEEL -->
  <div class="card hidden" id="wheel">
    <div class="center" style="font-weight:900; margin-bottom:8px;">üé∞ Roue (1 fois / semaine)</div>

    <div class="gainList">
      <div style="font-weight:900;">üéÅ Gains possibles (sans %)</div>
      <ul>
        <li>100 meuje filtre</li>
        <li>-90% sur tout le catalogue</li>
        <li>Livraison gratuite</li>
        <li>Starter pack (feuille + briquet + jeux √† gratter)</li>
        <li>Merci pour votre participation</li>
      </ul>
      <div class="tiny" style="margin-top:8px;">
        Le gain est valable uniquement apr√®s validation r√©elle du livreur.
      </div>
    </div>

    <div class="divider"></div>

    <label class="muted">Code validation (donn√© par le livreur)</label>
    <input id="wheelCode" placeholder="Ex: VALID-XXXX" />

    <button class="btn" id="validateBtn" onclick="validateWheelCode()">Valider la commande</button>

    <div id="verifiedBox" class="okBox hidden" style="margin-top:10px;">
      <div style="font-weight:900;">‚úÖ Commande v√©rifi√©e</div>
      <div class="muted">Acc√®s √† la roulette d√©bloqu√©.</div>
      <div class="muted">Prochaine √©ligibilit√© : <span id="wheelNextInfo">‚Äî</span></div>
    </div>

    <div class="rouletteWrap hidden" id="rouletteWrap">
      <canvas id="rouletteCanvas" width="520" height="520"></canvas>
      <button class="btn" id="spinBtn" onclick="spinRoulette()">Lancer la roulette</button>
      <div id="wheelMsg" class="center" style="margin-top:6px; font-weight:900;"></div>
      <div id="wheelWinCode" class="center muted" style="margin-top:6px;"></div>
    </div>

    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- REFERRAL -->
  <div class="card hidden" id="referral">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Programme Partenaire</div>

    <div class="muted">
      Paliers : <b>3 filleuls = -20‚Ç¨</b> ‚Ä¢ <b>5 = -30‚Ç¨</b> ‚Ä¢ <b>10 = -100‚Ç¨</b><br/>
      <span class="tiny">Validation manuelle par le vendeur.</span>
    </div>

    <div class="divider"></div>

    <div class="sumrow"><span>Ton code</span><strong id="myRefCode">‚Äî</strong></div>
    <div class="sumrow"><span>Filleuls valid√©s</span><strong id="refCount">0</strong></div>
    <div class="center" id="refStatus" style="margin-top:8px; font-weight:900;"></div>

    <button class="btn secondary" onclick="shareReferral()">Partager mon code</button>

    <div class="divider"></div>
    <div class="muted" style="margin-bottom:8px;">(Vendeur) Ajouter 1 filleul valid√© :</div>
    <input id="sellerPin" placeholder="Code vendeur (PIN)" />
    <button class="btn" onclick="sellerAddReferral()">Valider 1 filleul</button>
    <div class="tiny">PIN par d√©faut (√† changer dans le code) : <b>0000</b></div>

    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- CONTEST -->
  <div class="card hidden" id="contest">
    <div class="center" style="font-weight:900; margin-bottom:8px;">üèÜ Concours Cr√©ateur</div>
    <div class="muted">
      Fais la meilleure pub, poste-la, puis envoie le lien pour participer.
    </div>

    <div class="divider"></div>

    <label class="muted">Lien de ta vid√©o / pub</label>
    <input id="contestLink" placeholder="https://..." />

    <label class="muted">Plateforme</label>
    <select id="contestPlatform">
      <option value="TikTok">TikTok</option>
      <option value="Instagram">Instagram</option>
      <option value="Snapchat">Snapchat</option>
      <option value="Autre">Autre</option>
    </select>

    <label class="muted">Pseudo (optionnel)</label>
    <input id="contestUser" placeholder="@pseudo" />

    <button class="btn" onclick="sendContest()">Envoyer ma participation (WhatsApp)</button>
    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- APPLY -->
  <div class="card hidden" id="apply">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Postuler</div>

    <div class="row" style="justify-content:space-between">
      <div class="pill active" id="applyShopPill" onclick="applyType('shop')">üè™ Ouvrir un secteur</div>
      <div class="pill" id="applyDeliveryPill" onclick="applyType('delivery')">üöö Devenir livreur</div>
    </div>

    <div class="divider"></div>

    <label class="muted">Nom / Pr√©nom</label>
    <input id="applyName" placeholder="Nom Pr√©nom" />

    <label class="muted">Ville / D√©partement</label>
    <input id="applyCity" placeholder="Ville (D√©partement)" />

    <label class="muted">Disponibilit√©s</label>
    <input id="applyAvail" placeholder="Ex: soirs, week-end..." />

    <label class="muted">Message</label>
    <textarea id="applyMsg" rows="5" placeholder="Explique ton profil, ton exp√©rience, pourquoi toi..."></textarea>

    <button class="btn" onclick="sendApply()">Envoyer (WhatsApp)</button>
    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- SUPPORT -->
  <div class="card hidden" id="support">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Service Client</div>

    <label class="muted">Type</label>
    <select id="supportType">
      <option value="Avis">‚≠ê Avis</option>
      <option value="R√©clamation">‚ö†Ô∏è R√©clamation</option>
      <option value="Suggestion">üí° Suggestion</option>
    </select>

    <label class="muted">ID commande (si tu en as un)</label>
    <input id="supportOrderId" placeholder="Ex: 71-OMAR_SY-4827" />

    <label class="muted">Message</label>
    <textarea id="supportMsg" rows="6" placeholder="Explique ton message..."></textarea>

    <button class="btn" onclick="sendSupport()">Envoyer (WhatsApp)</button>
    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

</div>

<script>
     ========================= -->
  // =========================
  // CONFIG
  // =========================
  const WHATSAPP_NUMBER = "33600000000"; // <-- remplace par ton num√©ro (sans +)
  const SELLER_PIN = "0000";             // <-- PIN vendeur (parrainage)
  const VALIDATION_CODE = "VALID123";    // <-- code validation livreur (test)

  const EURO = (n) => `${n}‚Ç¨`;

  // Secteurs avec tourn√©es + d√©compte + hors tourn√©e
  const TOUR_SECTORS = new Set(["69","71"]);
  const PREMIUM_FEE = 60;

  // =========================
  // DATA
  // =========================
  const DATA = {
    "69": {
      label: "Menu 69 ‚Äî Villefranche-sur-Sa√¥ne",
      pickupHours: "07:00 ‚Üí 00:00",
      deliveryInfo: "Tourn√©es : 16h / 19h / 21h30 ‚Ä¢ Hors tourn√©e +60‚Ç¨",
      pickupCityDefault: "Villefranche-sur-Sa√¥ne",
      categories: [
        { name: "Jaune mousseux", items: [
          { name: "10 meuje", pickup: 40, delivery: 50 },
          { name: "25 meuje", pickup: 80, delivery: 100 },
          { name: "50 meuje", pickup: 140, delivery: 160 },
          { name: "100 meuje", pickup: 220, delivery: 240 }
        ]},
        { name: "Filtre x3 exotique", items: [
          { name: "3,5 meuje", pickup: 30, delivery: 40 },
          { name: "10 meuje", pickup: 60, delivery: 70 },
          { name: "20 meuje", pickup: 110, delivery: 130 },
          { name: "50 meuje", pickup: 220, delivery: 240 },
          { name: "100 meuje", pickup: 400, delivery: 430 }
        ]},
        { name: "Menu coco", items: [
          { name: "1 meuje", pickup: 50, delivery: 60 },
          { name: "2 meuje", pickup: 90, delivery: 100 },
          { name: "5 meuje", pickup: 200, delivery: 220 },
          { name: "10 meuje", pickup: 350, delivery: 370 }
        ]}
      ]
    },
    "71": {
      label: "Menu 71 ‚Äî M√¢con",
      pickupHours: "07:00 ‚Üí 00:00",
      deliveryInfo: "Tourn√©es : 16h / 19h / 21h30 ‚Ä¢ Hors tourn√©e +60‚Ç¨",
      categories: [
        { name: "Jaune mousseux", items: [
          { name: "10 meuje", pickup: 50, delivery: 60 },
          { name: "25 meuje", pickup: 100, delivery: 110 },
          { name: "50 meuje", pickup: 150, delivery: 180 },
          { name: "100 meuje", pickup: 230, delivery: 260 }
        ]},
        { name: "Filtre x3 exotique", items: [
          { name: "3,5 meuje", pickup: 30, delivery: 40 },
          { name: "10 meuje", pickup: 60, delivery: 80 },
          { name: "20 meuje", pickup: 110, delivery: 120 },
          { name: "50 meuje", pickup: 230, delivery: 250 },
          { name: "100 meuje", pickup: 420, delivery: 450 }
        ]},
        { name: "Menu coco", items: [
          { name: "1 meuje", pickup: 50, delivery: 60 },
          { name: "2 meuje", pickup: 90, delivery: 120 },
          { name: "5 meuje", pickup: 200, delivery: 220 },
          { name: "10 meuje", pickup: 350, delivery: 380 }
        ]}
      ]
    }
  };

  // =========================
  // ORDER ID (secteur + nom + 4 chiffres)
  // =========================
  function generateOrderId(sec){
    const names = [
      "OMAR_SY","GAD_ELMALEH","JEAN_DUJARDIN","MARION_COTILLARD","AUDREY_TAUTOU",
      "DANY_BOON","FRANCK_DUBOSC","FLORENCE_FORESTI","KAD_MERAD","VINCENT_CASSEL",
      "JAMEL_DEBBOUZE","VANESSA_PARADIS","CHARLOTTE_GAINSBOURG","LAETITIA_CASTA",
      "JEAN_RENO","LOUIS_DE_FUNES","GEORGES_BRASSENS","EDITH_PIAF"
    ];
    const who = names[Math.floor(Math.random() * names.length)];
    const num = Math.floor(1000 + Math.random() * 9000);
    return `${sec}-${who}-${num}`;
  }

  // =========================
  // NAV
  // =========================
  const SECTIONS = ["home","stepSector","stepRubric","stepDeliveryOptions","stepMenu","stepSummary","wheel","referral","contest","apply","support"];
  function hideAll(){ SECTIONS.forEach(id => document.getElementById(id).classList.add("hidden")); }
  function go(id){
    hideAll();
    document.getElementById(id).classList.remove("hidden");
    if(id === "referral") renderReferral();
    if(id === "wheel") resetWheelUI();
  }

  // =========================
  // STATE
  // =========================
  let sector = null;          // "69" | "71"
  let mode = null;            // "pickup" | "delivery"
  let pickupCity = null;
  let activeCat = 0;
  let deliveryTour = null;    // "16:00" | "19:00" | "21:30" | null
  let premium = false;        // hors tourn√©e +60
  let currentOrderId = null;

  const cart = new Map();

  // UI refs
  const stepRubric = document.getElementById("stepRubric");
  const stepDeliveryOptions = document.getElementById("stepDeliveryOptions");
  const stepMenu = document.getElementById("stepMenu");
  const stepSummary = document.getElementById("stepSummary");

  const rubricTitle = document.getElementById("rubricTitle");
  const rubricInfo = document.getElementById("rubricInfo");
  const pillPickup = document.getElementById("pillPickup");
  const pillDelivery = document.getElementById("pillDelivery");

  const menuTitle = document.getElementById("menuTitle");
  const categoryRow = document.getElementById("categoryRow");
  const itemsList = document.getElementById("itemsList");
  const subtotalEl = document.getElementById("subtotal");
  const totalEl = document.getElementById("total");
  const premiumRow = document.getElementById("premiumRow");

  const delivery71Tours = document.getElementById("delivery71Tours");
  const premiumPill = document.getElementById("premiumPill");
  const addrEl = document.getElementById("address");
  const noteEl = document.getElementById("note");
  const delivery69Passage = document.getElementById("delivery69Passage");

  // Summary refs
  const sumOrderId = document.getElementById("sumOrderId");
  const sumSector = document.getElementById("sumSector");
  const sumMode = document.getElementById("sumMode");
  const sumPickupCityRow = document.getElementById("sumPickupCityRow");
  const sumPickupCity = document.getElementById("sumPickupCity");
  const sumItems = document.getElementById("sumItems");
  const sumSubtotal = document.getElementById("sumSubtotal");
  const sumTotal = document.getElementById("sumTotal");
  const sumPremiumFeeRow = document.getElementById("sumPremiumFeeRow");
  const sumPremiumFee = document.getElementById("sumPremiumFee");

  const sumDeliveryBlock = document.getElementById("sumDeliveryBlock");
  const sumAddress = document.getElementById("sumAddress");
  const sumNote = document.getElementById("sumNote");
  const sumTourRow = document.getElementById("sumTourRow");
  const sumTour = document.getElementById("sumTour");
  const sumPremiumRow = document.getElementById("sumPremiumRow");

  function setActivePill(el, on){ el.classList.toggle("active", !!on); }
  function clearToursUI(){
    ["tour16","tour19","tour2130"].forEach(id => document.getElementById(id).classList.remove("active"));
    premiumPill.classList.remove("active");
  }

  // =========================
  // SECTOR FLOWS
  // =========================
  function selectSector(s){
    sector = s;
    mode = null;
    pickupCity = (s === "69") ? DATA["69"].pickupCityDefault : null;
    activeCat = 0;
    deliveryTour = null; premium = false;
    cart.clear();
    addrEl.value = ""; noteEl.value = "";
    clearToursUI();

    hideAll();
    stepRubric.classList.remove("hidden");

    rubricTitle.textContent = DATA[sector].label;
    rubricInfo.innerHTML =
      `üè¢ Sur place : ${DATA[sector].pickupHours}<br/>` +
      `üöò ${DATA[sector].deliveryInfo}`;

    setActivePill(pillPickup, false);
    setActivePill(pillDelivery, false);
  }

  function quick71Pickup(city){
    sector = "71";
    mode = "pickup";
    pickupCity = city;
    activeCat = 0;
    deliveryTour = null; premium = false;
    cart.clear();
    addrEl.value = ""; noteEl.value = "";
    clearToursUI();
    goToMenu();
  }

  function quick71Delivery(){
    sector = "71";
    mode = "delivery";
    pickupCity = null;
    activeCat = 0;
    deliveryTour = deliveryTour || "16:00";
    premium = false;
    cart.clear();
    addrEl.value = ""; noteEl.value = "";
    clearToursUI();

    hideAll();
    stepDeliveryOptions.classList.remove("hidden");
    delivery71Tours.classList.remove("hidden");
    delivery69Passage.classList.add("hidden");
    selectTour(deliveryTour);
    startTourTicker();
  }

  function selectMode(m){
    mode = m;
    setActivePill(pillPickup, mode === "pickup");
    setActivePill(pillDelivery, mode === "delivery");

    if(mode === "delivery"){
      hideAll();
      stepDeliveryOptions.classList.remove("hidden");

      const showTours = TOUR_SECTORS.has(sector);
      delivery71Tours.classList.toggle("hidden", !showTours);

      // Affiche le mini bloc "passage" uniquement en 69
      if(showTours){
        delivery69Passage.classList.toggle("hidden", sector !== "69");
      }

      if(showTours){
        deliveryTour = deliveryTour || "16:00";
        selectTour(deliveryTour);
        startTourTicker();
      } else {
        deliveryTour = null; premium = false;
      }
    } else {
      pickupCity = (sector === "69") ? DATA["69"].pickupCityDefault : (pickupCity || "M√¢con");
      goToMenu();
    }
  }

  function backToRubric(){
    hideAll();
    stepRubric.classList.remove("hidden");
  }

  function selectTour(t){
    if(!TOUR_SECTORS.has(sector)) return;
    deliveryTour = t;
    clearToursUI();
    if(t === "16:00") document.getElementById("tour16").classList.add("active");
    if(t === "19:00") document.getElementById("tour19").classList.add("active");
    if(t === "21:30") document.getElementById("tour2130").classList.add("active");
    if(premium) premiumPill.classList.add("active");
  }

  function togglePremium(){
    if(!TOUR_SECTORS.has(sector) || mode !== "delivery") return;
    premium = !premium;
    premiumPill.classList.toggle("active", premium);
  }

  function goToMenu(){
    if(!sector || !mode){
      alert("Choisis un secteur et un mode.");
      return;
    }

    if(mode === "delivery"){
      const addr = (addrEl.value || "").trim();
      if(!addr){
        alert("Adresse obligatoire pour la livraison.");
        return;
      }
      if(TOUR_SECTORS.has(sector) && !deliveryTour && !premium){
        alert("Choisis une tourn√©e (ou hors tourn√©e).");
        return;
      }
    }

    hideAll();
    stepMenu.classList.remove("hidden");
    renderMenu();
  }

  function backFromMenu(){
    if(mode === "delivery"){
      hideAll(); stepDeliveryOptions.classList.remove("hidden");
      if(TOUR_SECTORS.has(sector)) startTourTicker();
    } else if(sector === "69"){
      hideAll(); stepRubric.classList.remove("hidden");
    } else {
      hideAll(); document.getElementById("stepSector").classList.remove(

     ========================= -->
  function clearCart(){
    cart.clear();
    renderMenu();
  }

  function renderMenu(){
    const sec = DATA[sector];
    let subtitle = (mode === "pickup") ? "Sur place" : "Livraison";
    if(mode === "pickup" && pickupCity) subtitle += ` ‚Äî ${pickupCity}`;
    menuTitle.textContent = `${sec.label} ‚Äî ${subtitle}`;

    const premFee = (TOUR_SECTORS.has(sector) && mode === "delivery" && premium) ? PREMIUM_FEE : 0;
    premiumRow.classList.toggle("hidden", premFee === 0);

    categoryRow.innerHTML = "";
    sec.categories.forEach((c, idx) => {
      const p = document.createElement("div");
      p.className = "pill" + (idx === activeCat ? " active" : "");
      p.textContent = c.name;
      p.onclick = () => { activeCat = idx; renderMenu(); };
      categoryRow.appendChild(p);
    });

    itemsList.innerHTML = "";
    const cat = sec.categories[activeCat];

    cat.items.forEach((it, itemIdx) => {
      const key = `${activeCat}:${itemIdx}`;
      const qty = cart.get(key) || 0;
      const price = (mode === "pickup") ? it.pickup : it.delivery;

      const row = document.createElement("div");
      row.className = "item";

      const left = document.createElement("div");
      left.innerHTML = `<div class="name">${it.name}</div><div class="price">${EURO(price)}</div>`;

      const right = document.createElement("div");
      right.className = "qty";

      const minus = document.createElement("button");
      minus.className = "qbtn";
      minus.textContent = "‚àí";
      minus.onclick = () => {
        const q = cart.get(key) || 0;
        if(q <= 0) return;
        if(q === 1) cart.delete(key);
        else cart.set(key, q - 1);
        renderMenu();
      };

      const num = document.createElement("div");
      num.className = "qnum";
      num.textContent = qty;

      const plus = document.createElement("button");
      plus.className = "qbtn";
      plus.textContent = "+";
      plus.onclick = () => {
        const q = cart.get(key) || 0;
        cart.set(key, q + 1);
        renderMenu();
      };

      right.appendChild(minus);
      right.appendChild(num);
      right.appendChild(plus);

      row.appendChild(left);
      row.appendChild(right);
      itemsList.appendChild(row);
    });

    const sub = computeSubtotal();
    const prem = (TOUR_SECTORS.has(sector) && mode === "delivery" && premium) ? PREMIUM_FEE : 0;
    subtotalEl.textContent = EURO(sub);
    totalEl.textContent = EURO(sub + prem);
  }

  function computeSubtotal(){
    const sec = DATA[sector];
    let sum = 0;
    for(const [key, qty] of cart.entries()){
      const [cIdx, iIdx] = key.split(":").map(Number);
      const item = sec.categories[cIdx].items[iIdx];
      const price = (mode === "pickup") ? item.pickup : item.delivery;
      sum += price * qty;
    }
    return sum;
  }

  function buildOrderPayload(){
    const sec = DATA[sector];
    const sub = computeSubtotal();
    const premFee = (TOUR_SECTORS.has(sector) && mode === "delivery" && premium) ? PREMIUM_FEE : 0;
    const total = sub + premFee;

    const items = [];
    for(const [key, qty] of cart.entries()){
      const [cIdx, iIdx] = key.split(":").map(Number);
      const cat = sec.categories[cIdx];
      const item = cat.items[iIdx];
      const unit = (mode === "pickup") ? item.pickup : item.delivery;
      items.push({ cat: cat.name, name: item.name, qty, unit, line: unit * qty });
    }

    const refCode = (document.getElementById("referrerCode").value || "").trim();

    return {
      orderId: currentOrderId,
      sector,
      sectorLabel: sec.label,
      mode,
      pickupCity: (mode === "pickup") ? (pickupCity || "") : "",
      delivery: {
        tour: (TOUR_SECTORS.has(sector) && mode === "delivery") ? (premium ? null : (deliveryTour || null)) : null,
        premium: (TOUR_SECTORS.has(sector) && mode === "delivery") ? premium : false,
        premiumFee: premFee,
        address: (mode === "delivery") ? (addrEl.value || "").trim() : "",
        note: (mode === "delivery") ? (noteEl.value || "").trim() : ""
      },
      referral: { referrerCode: refCode || "" },
      pricing: {
        currency: "EUR",
        subtotal: sub,
        premiumFee: premFee,
        totalWithoutDistance: total,
        distanceRule: "10‚Ç¨/15km (calcul vendeur)",
        extraRule: "La direction peut ajouter des frais selon km"
      },
      payment: "main_propre",
      items,
      createdAt: new Date().toISOString()
    };
  }

  function goToSummary(){
    const sub = computeSubtotal();
    if(sub <= 0){ alert("Ajoute au moins un produit."); return; }

    if(mode === "delivery" && !((addrEl.value || "").trim())){
      alert("Adresse obligatoire pour la livraison.");
      return;
    }

    currentOrderId = generateOrderId(sector);
    const payload = buildOrderPayload();

    sumOrderId.textContent = payload.orderId;
    sumSector.textContent = payload.sectorLabel;
    sumMode.textContent = (payload.mode === "pickup") ? "Sur place" : "Livraison";

    if(payload.mode === "pickup" && payload.pickupCity){
      sumPickupCityRow.style.display = "flex";
      sumPickupCity.textContent = payload.pickupCity;
    } else {
      sumPickupCityRow.style.display = "none";
      sumPickupCity.textContent = "‚Äî";
    }

    sumItems.innerHTML = "";
    payload.items.forEach(it => {
      const div = document.createElement("div");
      div.className = "sumrow";
      div.innerHTML = `<span class="muted">${it.name} x${it.qty}</span><strong>${EURO(it.line)}</strong>`;
      sumItems.appendChild(div);
    });

    sumSubtotal.textContent = EURO(payload.pricing.subtotal);
    sumPremiumFeeRow.style.display = (payload.pricing.premiumFee > 0) ? "flex" : "none";
    sumPremiumFee.textContent = EURO(payload.pricing.premiumFee);
    sumTotal.textContent = EURO(payload.pricing.totalWithoutDistance);

    if(payload.mode === "delivery"){
      sumDeliveryBlock.classList.remove("hidden");
      sumAddress.textContent = payload.delivery.address || "‚Äî";
      sumNote.textContent = payload.delivery.note || "‚Äî";

      const showTour = (TOUR_SECTORS.has(payload.sector) && !payload.delivery.premium);
      sumTourRow.style.display = showTour ? "flex" : "none";
      sumTour.textContent = showTour ? (payload.delivery.tour || "‚Äî") : "‚Äî";
      sumPremiumRow.style.display = (TOUR_SECTORS.has(payload.sector) && payload.delivery.premium) ? "flex" : "none";
    } else {
      sumDeliveryBlock.classList.add("hidden");
    }

    localStorage.setItem("lastOrderPayload", JSON.stringify(payload));

    hideAll();
    stepSummary.classList.remove("hidden");
  }

  function buildWhatsAppMessage(payload){
    const lines = [];
    lines.push("‚úÖ COMMANDE OFFICIELLE");
    lines.push("");
    lines.push(`ID : ${payload.orderId}`);
    lines.push(`Secteur : ${payload.sectorLabel}`);
    lines.push(`Mode : ${payload.mode === "pickup" ? "Sur place" : "Livraison"}`);
    if(payload.mode === "pickup" && payload.pickupCity){
      lines.push(`Ville : ${payload.pickupCity}`);
    }
    lines.push("");

    if(payload.mode === "delivery"){
      if(TOUR_SECTORS.has(payload.sector)){
        if(payload.delivery.premium){
          lines.push(`‚òÖ Hors tourn√©e : OUI (+${PREMIUM_FEE}‚Ç¨)`);
        } else {
          lines.push(`Tourn√©e : ${payload.delivery.tour || "‚Äî"}`);
        }
      }
      lines.push("");
      lines.push("Adresse :");
      lines.push(payload.delivery.address || "‚Äî");
      if(payload.delivery.note){
        lines.push("");
        lines.push(`Note : ${payload.delivery.note}`);
      }
      lines.push("");
    }

    lines.push("Produits :");
    payload.items.forEach(it => lines.push(`- ${it.name} x${it.qty} = ${it.line}‚Ç¨`));

    lines.push("");
    lines.push(`Sous-total : ${payload.pricing.subtotal}‚Ç¨`);
    if(payload.pricing.premiumFee > 0) lines.push(`Hors tourn√©e : +${payload.pricing.premiumFee}‚Ç¨`);
    lines.push(`TOTAL (hors distance) : ${payload.pricing.totalWithoutDistance}‚Ç¨`);
    lines.push(`Frais distance : ${payload.pricing.distanceRule}`);
    lines.push("");

    if(payload.referral?.referrerCode){
      lines.push(`Code partenaire : ${payload.referral.referrerCode}`);
    } else {
      lines.push("Code partenaire : (si tu en as un, √©cris-le ici)");
    }

    lines.push("");
    lines.push("Paiement : main propre");
    lines.push("");
    lines.push("üé∞ ROUE : gain valable uniquement apr√®s validation r√©elle du livreur.");
    lines.push("Sans validation, aucun gain ne sera pris en compte.");

    return lines.join("\n");
  }

  function confirmToWhatsApp(){
    const raw = localStorage.getItem("lastOrderPayload");
    if(!raw){ alert("Aucune commande trouv√©e."); return; }
    const payload = JSON.parse(raw);

    localStorage.setItem("lastOrderId", payload.orderId);
    localStorage.setItem("lastOrderTs", String(Date.now()));

    const msg = buildWhatsAppMessage(payload);
    window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
  }

  // =========================
  // TOUR COUNTDOWN (69 + 71)
  // =========================
  let tourTicker = null;

  function parseTodayTime(hhmm){
    const [hh, mm] = hhmm.split(":").map(Number);
    const d = new Date();
    d.setHours(hh, mm, 0, 0);
    return d;
  }

  function getNextTourInfo(){
    const tours = ["16:00","19:00","21:30"];
    const now = new Date();

    for(const t of tours){
      const dt = parseTodayTime(t);
      if(dt.getTime() > now.getTime()){
        return { label: t, time: dt };
      }
    }
    const tomorrow = new Date(now.getTime() + 24*60*60*1000);
    tomorrow.setHours(16,0,0,0);
    return { label: "demain 16:00", time: tomorrow };
  }

  function fmtCountdown(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const ss = s%60;
    const pad = (x)=>String(x).padStart(2,"0");
    if(h > 0) return `${pad(h)}h${pad(m)}m`;
    return `${pad(m)}m${pad(ss)}s`;
  }

  function startTourTicker(){
    if(!TOUR_SECTORS.has(sector) || mode !== "delivery") return;

    const labelEl = document.getElementById("nextTourLabel");
    const cdEl = document.getElementById("nextTourCountdown");
    if(tourTicker) clearInterval(tourTicker);

    const tick = ()=>{
      const info = getNextTourInfo();
      labelEl.textContent = info.label;
      cdEl.textContent = fmtCountdown(info.time.getTime() - Date.now());
    };
    tick();
    tourTicker = setInterval(tick, 1000);
  }

  // =========================
  // WHEEL: validation + weekly limit + roulette animation
  // =========================
  function canSpinThisWeek(){
    const last = Number(localStorage.getItem("wheel:lastSpinTs") || "0");
    if(!last) return true;
    return (Date.now() - last) >= 7*24*60*60*1000;
  }
  function nextEligibleText(){
    const last = Number(localStorage.getItem("wheel:lastSpinTs") || "0");
    if(!last) return "Maintenant";
    const remain = 7*24*60*60*1000 - (Date.now() - last);
    if(remain <= 0) return "Maintenant";
    const days = Math.ceil(remain / (24*60*60*1000));
    return `${days} jour(s)`;
  }
  function makeWinCode(prefix="WIN"){
    const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
    let s = "";
    for(let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return `${prefix}-${s}`;
  }

  const PRIZES = [
    { id:"WIN_100_FILTER", label:"üéÅ 100 meuje filtre", p:0.05 },
    { id:"WIN_90_OFF",     label:"üéÅ -90% sur tout le catalogue", p:0.05 },
    { id:"WIN_FREE_DEL",   label:"üéÅ Livraison gratuite", p:10.0 },
    { id:"WIN_STARTER",    label:"üéÅ Starter pack", p:25.0 },
    { id:"LOSE",           label:"üòÖ Merci pour votre participation", p:64.9 }
  ];

  const SEGMENTS = [
    { id:"LOSE", label:"PERDU" },
    { id:"WIN_STARTER", label:"STARTER" },
    { id:"LOSE", label:"PERDU" },
    { id:"WIN_FREE_DEL", label:"LIVRAISON" },
    { id:"LOSE", label:"PERDU" },
    { id:"WIN_90_OFF", label:"-90%" },
    { id:"LOSE", label:"PERDU" },
    { id:"WIN_100_FILTER", label:"100" }
  ];

  let wheelVerified = false;
  let rouletteRunning = false;

  const validateBtn = document.getElementById("validateBtn");
  const verifiedBox = document.getElementById("verifiedBox");
  const wheelNextInfo = document.getElementById("wheelNextInfo");
  const rouletteWrap = document.getElementById("rouletteWrap");
  const wheelMsg = document.getElementById("wheelMsg");
  const wheelWinCode = document.getElementById("wheelWinCode");
  const spinBtn = document.getElementById("spinBtn");

  function resetWheelUI(){
    wheelVerified = false;
    rouletteRunning = false;
    verifiedBox.classList.add("hidden");
    rouletteWrap.classList.add("hidden");
    wheelMsg.textContent = "";
    wheelWinCode.textContent = "";
    document.getElementById("wheelCode").value = "";
    validateBtn.disabled = false;
    spinBtn.disabled = false;
    wheelNextInfo.textContent = nextEligibleText();
    drawRoulette(0, 0);
  }

  function validateWheelCode(){
    wheelMsg.textContent = "";
    wheelWinCode.textContent = "";

    if(!canSpinThisWeek()){
      wheelMsg.textContent = "‚õî D√©j√† jou√© cette semaine.";
      wheelNextInfo.textContent = nextEligibleText();
      return;
    }

    const code = (document.getElementById("wheelCode").value || "").trim();
    if(code !== VALIDATION_CODE){
      wheelMsg.textContent = "‚ùå Code invalide. Attends la validation du livreur.";
      return;
    }

    wheelVerified = true;
    validateBtn.disabled = true;
    verifiedBox.classList.remove("hidden");
    rouletteWrap.classList.remove("hidden");
    wheelNextInfo.textContent = "Apr√®s ce tour : 7 jours";
    drawRoulette(0, 0);
  }

  function weightedPick(prizes){
    const total = prizes.reduce((s,x)=>s+x.p,0);
    let r = Math.random()*total;
    for(const x of prizes){
      r -= x.p;
      if(r <= 0) return x;
    }
    return prizes[prizes.length-1];
  }

  function pickTargetSegment(prizeId){
    const candidates = [];
    for(let i=0;i<SEGMENTS.length;i++){
      if(SEGMENTS[i].id === prizeId) candidates.push(i);
    }
    if(candidates.length === 0){
      for(let i=0;i<SEGMENTS.length;i++){
        if(SEGMENTS[i].id === "LOSE") candidates.push(i);
      }
    }
    return candidates[Math.floor(Math.random()*candidates.length)];
  }

  const canvas = document.getElementById("rouletteCanvas");
  const ctx = canvas.getContext("2d");

  function drawRoulette(wheelAngle, ballAngle){
    const w = canvas.width, h = canvas.height;
    const cx = w/2, cy = h/2;
    const R = Math.min(w,h)/2 - 18;
    const ringR = R;
    const innerR = R * 0.62;

    ctx.clearRect(0,0,w,h);

    ctx.beginPath();
    ctx.arc(cx, cy, ringR+10, 0, Math.PI*2);
    ctx.fillStyle = "rgba(0,0,0,0.25)";
    ctx.fill();

    const n = SEGMENTS.length;
    const seg = (Math.PI*2)/n;

    for(let i=0;i<n;i++){
      const a0 = wheelAngle + i*seg;
      const a1 = a0 + seg;

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,ringR,a0,a1);
      ctx.closePath();

      const isRed = i%2===0;
      ctx.fillStyle = isRed ? "rgba(220,20,60,0.9)" : "rgba(20,160,80,0.9)";
      ctx.fill();

      ctx.strokeStyle = "rgba(255,255,255,0.15)";
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.save();
      ctx.translate(cx,cy);
      const mid = a0 + seg/2;
      ctx.rotate(mid);
      ctx.textAlign = "right";
      ctx.fillStyle = "rgba(255,255,255,0.95)";
      ctx.font = "bold 18px Arial";
      ctx.fillText(SEGMENTS[i].label, ringR - 14, 6);
      ctx.restore();
    }

    ctx.beginPath();
    ctx.arc(cx,cy,innerR,0,Math.PI*2);
    ctx.fillStyle = "rgba(0,0,0,0.45)";
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(cx, cy - ringR - 6);
    ctx.lineTo(cx - 14, cy - ringR + 18);
    ctx.lineTo(cx + 14, cy - ringR + 18);
    ctx.closePath();
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.fill();

    const ballR = 7;
    const trackR = ringR - 12;
    const bx = cx + trackR * Math.cos(ballAngle);
    const by = cy + trackR * Math.sin(ballAngle);

    ctx.beginPath();
    ctx.arc(bx+2, by+2, ballR, 0, Math.PI*2);
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fill();

    ctx.beginPath();
    ctx.arc(bx, by, ballR, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,0.25)";
    ctx.lineWidth = 1;
    ctx.stroke();
  }

  function spinRoulette(){
    if(!wheelVerified){
      wheelMsg.textContent = "Valide d'abord la commande.";
      return;
    }
    if(!canSpinThisWeek()){
      wheelMsg.textContent = "‚õî D√©j√† jou√© cette semaine.";
      return;
    }
    if(rouletteRunning) return;

    rouletteRunning = true;
    spinBtn.disabled = true;
    wheelMsg.textContent = "";
    wheelWinCode.textContent = "";

    const prize = weightedPick(PRIZES);
    const targetIdx = pickTargetSegment(prize.id);

    const n = SEGMENTS.length;
    const seg = (Math.PI*2)/n;
    const pointerAngle = -Math.PI/2;

    const targetCenter = (targetIdx + 0.5) * seg;
    let finalWheelAngle = pointerAngle - targetCenter;

    const spins = 10 + Math.floor(Math.random()*6);
    finalWheelAngle -= spins * Math.PI*2;

    let wheelAngle = 0;
    let ballAngle = Math.PI/2;

    const start = performance.now();
    const dur = 4200;

    function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

    const startWheel = wheelAngle;
    const deltaWheel = finalWheelAngle - startWheel;

    const startBall = ballAngle;
    const deltaBall = (Math.PI*2) * (18 + Math.random()*6);

    function frame(now){
      const t = Math.min(1, (now - start)/dur);
      const e = easeOutCubic(t);

      wheelAngle = startWheel + deltaWheel * e;
      const eb = 1 - Math.pow(1 - t, 2.2);
      ballAngle = startBall + (-deltaBall) * eb;

      drawRoulette(wheelAngle, ballAngle);

      if(t < 1){
        requestAnimationFrame(frame);
      } else {
        localStorage.setItem("wheel:lastSpinTs", String(Date.now()));
        const winCode = (prize.id === "LOSE") ? "" : makeWinCode("WIN");
        localStorage.setItem("wheel:lastPrize", prize.id);
        localStorage.setItem("wheel:lastWinCode", winCode);

        wheelMsg.textContent = prize.label + " ‚úÖ";
        wheelWinCode.textContent = winCode ? `Code : ${winCode} (√† v√©rifier √† la remise)` : "";

        rouletteRunning = false;
        wheelVerified = false;
        validateBtn.disabled = false;
        verifiedBox.classList.add("hidden");
        rouletteWrap.classList.add("hidden");
        wheelNextInfo.textContent = nextEligibleText();
      }
    }

    requestAnimationFrame(frame);
  }

  // =========================
  // REFERRAL
  // =========================
  function ensureMyRefCode(){
    let code = localStorage.getItem("ref:myCode");
    if(!code){
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let s="";
      for(let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
      code = `REF-${s}`;
      localStorage.setItem("ref:myCode", code);
    }
    return code;
  }
  function getRefCount(){ return Number(localStorage.getItem("ref:count") || "0"); }
  function setRefCount(n){ localStorage.setItem("ref:count", String(n)); }

  function renderReferral(){
    document.getElementById("myRefCode").textContent = ensureMyRefCode();
    const c = getRefCount();
    document.getElementById("refCount").textContent = String(c);

    let status = "";
    if(c >= 10) status = "‚úÖ Palier atteint : -100‚Ç¨";
    else if(c >= 5) status = "‚úÖ Palier atteint : -30‚Ç¨ (prochain : 10 ‚Üí -100‚Ç¨)";
    else if(c >= 3) status = "‚úÖ Palier atteint : -20‚Ç¨ (prochain : 5 ‚Üí -30‚Ç¨)";
    else status = `Encore ${3-c} filleul(s) pour d√©bloquer -20‚Ç¨`;
    document.getElementById("refStatus").textContent = status;
  }

  function shareReferral(){
    const code = ensureMyRefCode();
    const link = window.location.href;
    const text =
`üî• Nouveau concept
Viens voir le menu : ${link}

Code partenaire : ${code}
(√† mettre dans la commande)`;
    window.location.href = `https://wa.me/?text=${encodeURIComponent(text)}`;
  }

  function sellerAddReferral(){
    const pin = (document.getElementById("sellerPin").value || "").trim();
    if(pin !== SELLER_PIN){
      alert("PIN vendeur incorrect.");
      return;
    }
    const c = getRefCount() + 1;
    setRefCount(c);
    document.getElementById("sellerPin").value = "";
    renderReferral();
    alert("‚úÖ 1 filleul valid√© ajout√©.");
  }

  // =========================
  // CONTEST
  // =========================
  function sendContest(){
    const link = (document.getElementById("contestLink").value || "").trim();
    const platform = document.getElementById("contestPlatform").value;
    const user = (document.getElementById("contestUser").value || "").trim();

    if(!link){ alert("Mets le lien de ta vid√©o."); return; }

    const msg =
`üèÜ CONCOURS CR√âATEUR

Plateforme : ${platform}
Pseudo : ${user || "‚Äî"}
Lien : ${link}`;

    window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
  }

  // =========================
  // APPLY
  // =========================
  let applyKind = "shop";
  function applyType(kind){
    applyKind = kind;
    document.getElementById("applyShopPill").classList.toggle("active", kind === "shop");
    document.getElementById("applyDeliveryPill").classList.toggle("active", kind === "delivery");
  }
  function sendApply(){
    const name = (document.getElementById("applyName").value || "").trim();
    const city = (document.getElementById("applyCity").value || "").trim();
    const avail = (document.getElementById("applyAvail").value || "").trim();
    const msg = (document.getElementById("applyMsg").value || "").trim();

    if(!name || !city || !msg){
      alert("Remplis au minimum : Nom, Ville, Message.");
      return;
    }

    const title = (applyKind === "shop") ? "üè™ CANDIDATURE OUVRIR SECTEUR" : "üöö CANDIDATURE LIVREUR";
    const text =
`${title}

Nom : ${name}
Ville/D√©pt : ${city}
Dispos : ${avail || "‚Äî"}

Message :
${msg}`;

    window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  }

  // =========================
  // SUPPORT
  // =========================
  function sendSupport(){
    const type = document.getElementById("supportType").value;
    const oid = (document.getElementById("supportOrderId").value || "").trim();
    const msg = (document.getElementById("supportMsg").value || "").trim();

    if(!msg){ alert("√âcris ton message."); return; }

    const text =
`üì© SERVICE CLIENT

Type : ${type}
ID commande : ${oid || "‚Äî"}

Message :
${msg}`;

    window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  }

  // =========================
  // SHARE SITE
  // =========================
  function shareSite(){
    const link = window.location.href;
    const code = ensureMyRefCode();
    const text =
`D√©couvre le menu :
${link}

Code partenaire : ${code}`;
    window.location.href = `https://wa.me/?text=${encodeURIComponent(text)}`;
  }

  // Init
  go("home");
  drawRoulette(0, Math.PI/2);
</script>

</body>
</html>
