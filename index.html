<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MENU 69 / 71</title>

  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      color:#fff;
      background: url('IMG_7404.jpeg') no-repeat center center fixed;
      background-size: cover;
    }
    .overlay{
      min-height:100vh;
      background: rgba(0,0,0,.72);
      padding: 16px 14px 28px;
      max-width: 720px;
      margin: 0 auto;
    }
    h1{margin: 10px 0 6px; letter-spacing: 2px; text-align:center}
    .sub{opacity:.85; font-size:13px; text-align:center; margin-bottom: 10px}
    .card{
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.15);
      border-radius: 14px;
      padding: 12px;
      margin: 12px 0;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .btn{
      width:100%;
      background:#1e90ff;
      border:none;
      padding:14px 12px;
      margin: 8px 0;
      font-size:18px;
      color:#fff;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    .btn.secondary{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.2);
    }
    .btn.ghost{
      background: transparent;
      border:1px solid rgba(255,255,255,.2);
    }
    .btn.small{font-size:14px; padding:10px 12px; width:auto}
    .pill{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.2);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      user-select:none;
    }
    .pill.active{background: rgba(30,144,255,.95)}
    .muted{opacity:.82; font-size:13px}
    .divider{height:1px; background: rgba(255,255,255,.15); margin: 10px 0}
    .item{
      display:flex; justify-content:space-between; align-items:center;
      padding: 10px 0; border-bottom:1px solid rgba(255,255,255,.08);
    }
    .item:last-child{border-bottom:none}
    .name{font-weight:900}
    .price{opacity:.9; font-weight:900}
    .qty{display:flex; align-items:center; gap:8px}
    .qbtn{
      width:34px; height:34px; border-radius:10px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.2);
      color:#fff; font-weight:900; font-size:18px;
      cursor:pointer;
    }
    .qnum{min-width:18px; text-align:center; font-weight:900}
    textarea, input, select{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.35);
      color:#fff;
      padding: 12px;
      font-size: 14px;
      outline:none;
      box-sizing: border-box;
      margin-top: 6px;
    }
    .sumrow{
      display:flex; justify-content:space-between; align-items:center;
      padding:6px 0;
    }
    .sumrow strong{font-size:16px}
    .total strong{font-size:20px}
    .hidden{display:none}
    .center{text-align:center}
    .ok{color:#7bed9f; font-weight:900}
    .warn{color:#ffa502; font-weight:900}
    .tiny{font-size:12px; opacity:.78}
    .tag{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.10);
      font-weight:900;
      font-size:12px;
    }
  </style>
</head>

<body>
<div class="overlay">
  <h1>MENU</h1>
  <div class="sub" id="subline">Paiement : main propre ‚Ä¢ Frais distance : 10‚Ç¨ / 15km (calcul vendeur)</div>

  <!-- HOME -->
  <div class="card" id="home">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Accueil</div>
    <button class="btn" onclick="go('stepSector')">Commander</button>
    <button class="btn secondary" onclick="go('wheel')">üé∞ Roue (1 fois / semaine)</button>
    <button class="btn secondary" onclick="go('referral')">Programme Partenaire</button>
    <button class="btn secondary" onclick="go('contest')">Concours (tirage 15 jours)</button>
    <button class="btn secondary" onclick="go('postal')">üì¶ Envoi postal France</button>
    <button class="btn secondary" onclick="go('apply')">Postuler</button>
    <button class="btn secondary" onclick="go('support')">Service Client</button>
    <button class="btn secondary" onclick="shareSite()">Partager ce site</button>

    <div class="divider"></div>
    <div class="muted">
      <b>Important :</b> Les frais distance (10‚Ç¨ / 15km) sont calcul√©s par le vendeur.<br/>
      <span class="tiny">La direction se r√©serve le droit d‚Äôajouter des frais en fonction des kilom√®tres.</span>
    </div>
  </div>

  <!-- STEP 1: Secteur -->
  <div class="card hidden" id="stepSector">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Choisis ton secteur</div>
    <button class="btn" onclick="selectSector('69')">Menu 69 ‚Äî Villefranche-sur-Sa√¥ne</button>
    <button class="btn" onclick="selectSector('71')">Menu 71 ‚Äî M√¢con</button>
    <div class="muted center" style="margin-top:8px;">
      Sur place : 07:00 ‚Üí 00:00<br/>
      69 livraison : √† partir de 15h ‚Ä¢ 71 livraison : tourn√©es
    </div>
    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- STEP 2: Rubrique -->
  <div class="card hidden" id="stepRubric">
    <div class="center" style="font-weight:900; margin-bottom:8px;" id="rubricTitle">Choisis la rubrique</div>
    <div class="row">
      <div class="pill" id="pillPickup" onclick="selectMode('pickup')">üè¢ Sur place</div>
      <div class="pill" id="pillDelivery" onclick="selectMode('delivery')">üöò Livraison</div>
      <div class="pill" id="pillPostal" onclick="selectMode('postal')">üì¶ Envoi postal</div>
    </div>
    <div class="muted center" id="rubricInfo" style="margin-top:10px;"></div>
    <button class="btn ghost" onclick="go('stepSector')">‚Üê Retour</button>
  </div>

  <!-- STEP 3: Livraison options (adresse + tourn√©e/premium selon secteur) -->
  <div class="card hidden" id="stepDeliveryOptions">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Livraison</div>

    <div id="delivery71Tours" class="hidden">
      <div class="muted" style="margin-bottom:8px;">
        Menu 71 : tourn√©es <b>16:00</b> / <b>19:00</b> / <b>21:30</b><br/>
        Option <b>hors tourn√©e / hors horaires</b> : +60‚Ç¨
      </div>
      <div class="row">
        <div class="pill" id="tour16" onclick="selectTour('16:00')">16:00</div>
        <div class="pill" id="tour19" onclick="selectTour('19:00')">19:00</div>
        <div class="pill" id="tour2130" onclick="selectTour('21:30')">21:30</div>
      </div>
      <div style="margin-top:10px;">
        <div class="pill" id="premiumPill" onclick="togglePremium()">‚òÖ Hors tourn√©e +60‚Ç¨</div>
      </div>
      <div class="muted" style="margin-top:10px;">
        Si hors tourn√©e, tu peux indiquer une heure souhait√©e dans ‚ÄúNote‚Äù.
      </div>
    </div>

    <div class="divider"></div>

    <label class="muted">Adresse (obligatoire en livraison)</label>
    <textarea id="address" rows="3" placeholder="Adresse compl√®te + infos (√©tage, code...)"></textarea>

    <label class="muted" style="display:block; margin-top:10px;">Note (optionnel)</label>
    <input id="note" placeholder="Ex: heure souhait√©e, d√©tails..." />

    <div class="muted" style="margin-top:10px;">
      Frais distance : <b>10‚Ç¨ / 15km</b> (calcul vendeur).<br/>
      La direction se r√©serve le droit d‚Äôajouter des frais selon km.
    </div>

    <button class="btn" onclick="goToMenu()">Continuer</button>
    <button class="btn ghost" onclick="backToRubric()">‚Üê Retour</button>
  </div>

  <!-- STEP 3B: Postal options -->
  <div class="card hidden" id="stepPostalOptions">
    <div class="center" style="font-weight:900; margin-bottom:8px;">üì¶ Envoi postal (France enti√®re)</div>

    <label class="muted">Adresse compl√®te (obligatoire)</label>
    <textarea id="postalAddress" rows="4" placeholder="Nom + Adresse + Code postal + Ville"></textarea>

    <label class="muted" style="display:block; margin-top:10px;">T√©l√©phone (recommand√©)</label>
    <input id="postalPhone" placeholder="06..." />

    <label class="muted" style="display:block; margin-top:10px;">Note (optionnel)</label>
    <input id="postalNote" placeholder="Ex: point relais, pr√©cision..." />

    <div class="muted" style="margin-top:10px;">
      Les frais d‚Äôenvoi sont confirm√©s par le vendeur selon le colis / destination.
    </div>

    <button class="btn" onclick="goToMenu()">Continuer</button>
    <button class="btn ghost" onclick="backToRubric()">‚Üê Retour</button>
  </div>

  <!-- STEP 4: Menu (cat√©gories + items + panier) -->
  <div class="card hidden" id="stepMenu">
    <div class="center" style="font-weight:900; margin-bottom:8px;" id="menuTitle">Menu</div>

    <div class="row" id="categoryRow"></div>

    <div class="divider"></div>

    <div id="itemsList"></div>

    <div class="divider"></div>

    <label class="muted">Code parrain (optionnel)</label>
    <input id="referrerCode" placeholder="Ex: REF-AB12CD" />

    <div class="sumrow"><span>Sous-total</span><strong id="subtotal">0‚Ç¨</strong></div>
    <div class="sumrow hidden" id="premiumRow"><span>Hors tourn√©e</span><strong>+60‚Ç¨</strong></div>
    <div class="sumrow"><span>Frais distance</span><strong class="muted">√† ajouter (vendeur)</strong></div>
    <div class="sumrow total"><span>TOTAL (hors distance)</span><strong id="total">0‚Ç¨</strong></div>

    <div class="muted" style="margin-top:8px;">
      Paiement : main propre.
    </div>

    <button class="btn" onclick="goToSummary()">COMMANDER</button>
    <button class="btn secondary" onclick="clearCart()">Vider panier</button>
    <button class="btn ghost" onclick="backFromMenu()">‚Üê Retour</button>
  </div>

  <!-- STEP 5: Summary + Confirm (WhatsApp) -->
  <div class="card hidden" id="stepSummary">
    <div class="center" style="font-weight:900; margin-bottom:8px;">‚úÖ R√©capitulatif</div>
    <div class="muted center" style="margin-bottom:10px;">
      V√©rifie tout, puis confirme pour envoyer sur WhatsApp.
    </div>

    <div class="divider"></div>

    <div class="sumrow"><span><span class="tag">ID</span></span><strong id="sumOrderId">‚Äî</strong></div>
    <div class="sumrow"><span>Secteur</span><strong id="sumSector">‚Äî</strong></div>
    <div class="sumrow"><span>Mode</span><strong id="sumMode">‚Äî</strong></div>

    <div id="sumDeliveryBlock" class="hidden">
      <div class="divider"></div>
      <div class="sumrow"><span>Adresse</span><strong class="muted" id="sumAddress">‚Äî</strong></div>
      <div class="sumrow"><span>Note</span><strong class="muted" id="sumNote">‚Äî</strong></div>
      <div class="sumrow" id="sumTourRow"><span>Tourn√©e</span><strong id="sumTour">‚Äî</strong></div>
      <div class="sumrow" id="sumPremiumRow"><span>Hors tourn√©e</span><strong>+60‚Ç¨</strong></div>
    </div>

    <div id="sumPostalBlock" class="hidden">
      <div class="divider"></div>
      <div class="sumrow"><span>Adresse postale</span><strong class="muted" id="sumPostalAddress">‚Äî</strong></div>
      <div class="sumrow"><span>T√©l√©phone</span><strong class="muted" id="sumPostalPhone">‚Äî</strong></div>
      <div class="sumrow"><span>Note</span><strong class="muted" id="sumPostalNote">‚Äî</strong></div>
    </div>

    <div class="divider"></div>

    <div id="sumItems"></div>

    <div class="divider"></div>

    <div class="sumrow"><span>Sous-total</span><strong id="sumSubtotal">0‚Ç¨</strong></div>
    <div class="sumrow" id="sumPremiumFeeRow"><span>Hors tourn√©e</span><strong id="sumPremiumFee">0‚Ç¨</strong></div>
    <div class="sumrow"><span>TOTAL (hors distance)</span><strong id="sumTotal">0‚Ç¨</strong></div>

    <div class="divider"></div>
    <div class="muted">
      <b>üé∞ Roue :</b> Le gain n‚Äôest valable qu‚Äôapr√®s validation r√©elle du livreur.<br/>
      <span class="tiny">Sans validation, aucun gain ne sera pris en compte.</span>
    </div>

    <button class="btn" onclick="confirmToWhatsApp()">Confirmer & Envoyer WhatsApp</button>
    <button class="btn ghost" onclick="go('stepMenu')">‚Üê Modifier</button>
  </div>

  <!-- WHEEL -->
  <div class="card hidden" id="wheel">
    <div class="center" style="font-weight:900; margin-bottom:8px;">üé∞ Roue (1 fois / semaine)</div>

    <div class="muted center">
      1 tour maximum par semaine.<br/>
      Le gain est valable uniquement apr√®s validation r√©elle du livreur.
    </div>

    <div class="divider"></div>

    <label class="muted">Code validation (donn√© par le livreur)</label>
    <input id="wheelCode" placeholder="Ex: VALID-XXXX" />

    <button class="btn" onclick="spinWheel()">Valider & Tourner</button>
    <div id="wheelMsg" class="center" style="margin-top:10px; font-weight:900;"></div>
    <div id="wheelWinCode" class="center muted" style="margin-top:6px;"></div>

    <div class="divider"></div>
    <div class="tiny">
      Si tu n‚Äôas pas encore re√ßu le code, attends la validation du livreur.
    </div>

    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- REFERRAL -->
  <div class="card hidden" id="referral">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Programme Partenaire</div>

    <div class="muted">
      Paliers : <b>3 filleuls = -20‚Ç¨</b> ‚Ä¢ <b>5 = -30‚Ç¨</b> ‚Ä¢ <b>10 = -100‚Ç¨</b><br/>
      <span class="tiny">Validation manuelle par le vendeur.</span>
    </div>

    <div class="divider"></div>

    <div class="sumrow"><span>Ton code</span><strong id="myRefCode">‚Äî</strong></div>
    <div class="sumrow"><span>Filleuls valid√©s</span><strong id="refCount">0</strong></div>
    <div class="center" id="refStatus" style="margin-top:8px; font-weight:900;"></div>

    <button class="btn secondary" onclick="shareReferral()">Partager mon code</button>

    <div class="divider"></div>
    <div class="muted" style="margin-bottom:8px;">
      (Option vendeur) Ajouter une validation filleul :
    </div>
    <input id="sellerPin" placeholder="Code vendeur (PIN)" />
    <button class="btn" onclick="sellerAddReferral()">Valider 1 filleul</button>
    <div class="tiny">PIN par d√©faut (√† changer dans le code) : <b>0000</b></div>

    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- CONTEST -->
  <div class="card hidden" id="contest">
    <div class="center" style="font-weight:900; margin-bottom:8px;">üèÜ Concours (tirage 15 jours)</div>

    <div class="muted">
      Le concours reste dispo tout le temps.<br/>
      <b>Tirage au sort tous les 15 jours</b> + lot qui change.
    </div>

    <div class="divider"></div>

    <div class="sumrow"><span>Prochain tirage</span><strong id="contestCountdown">‚Äî</strong></div>
    <div class="sumrow"><span>Lot actuel</span><strong id="contestPrize">‚Äî</strong></div>

    <div class="divider"></div>

    <label class="muted">Lien de ta vid√©o / pub</label>
    <input id="contestLink" placeholder="https://..." />

    <label class="muted">Plateforme</label>
    <select id="contestPlatform">
      <option value="TikTok">TikTok</option>
      <option value="Instagram">Instagram</option>
      <option value="Snapchat">Snapchat</option>
      <option value="Autre">Autre</option>
    </select>

    <label class="muted">Pseudo (optionnel)</label>
    <input id="contestUser" placeholder="@pseudo" />

    <button class="btn" onclick="sendContest()">Envoyer ma participation (WhatsApp)</button>
    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- POSTAL -->
  <div class="card hidden" id="postal">
    <div class="center" style="font-weight:900; margin-bottom:8px;">üì¶ Envoi postal France</div>
    <div class="muted">
      Les frais d‚Äôenvoi sont confirm√©s par le vendeur selon le colis / destination.
    </div>
    <div class="divider"></div>
    <button class="btn" onclick="go('stepSector')">Faire une commande (avec panier)</button>
    <div class="tiny">Choisis ensuite ‚Äúüì¶ Envoi postal‚Äù dans la rubrique.</div>
    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- APPLY -->
  <div class="card hidden" id="apply">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Postuler</div>

    <div class="row" style="justify-content:space-between">
      <div class="pill active" id="applyShopPill" onclick="applyType('shop')">üè™ Ouvrir un secteur</div>
      <div class="pill" id="applyDeliveryPill" onclick="applyType('delivery')">üöö Devenir livreur</div>
    </div>

    <div class="divider"></div>

    <label class="muted">Nom / Pr√©nom</label>
    <input id="applyName" placeholder="Nom Pr√©nom" />

    <label class="muted">Ville / D√©partement</label>
    <input id="applyCity" placeholder="Ville (D√©partement)" />

    <label class="muted">Disponibilit√©s</label>
    <input id="applyAvail" placeholder="Ex: soirs, week-end..." />

    <label class="muted">Message</label>
    <textarea id="applyMsg" rows="5" placeholder="Explique ton profil, ton exp√©rience, pourquoi toi..."></textarea>

    <button class="btn" onclick="sendApply()">Envoyer (WhatsApp)</button>
    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

  <!-- SUPPORT -->
  <div class="card hidden" id="support">
    <div class="center" style="font-weight:900; margin-bottom:8px;">Service Client</div>

    <label class="muted">Type</label>
    <select id="supportType">
      <option value="Avis">‚≠ê Avis</option>
      <option value="R√©clamation">‚ö†Ô∏è R√©clamation</option>
      <option value="Suggestion">üí° Suggestion</option>
    </select>

    <label class="muted">ID commande (si tu en as un)</label>
    <input id="supportOrderId" placeholder="Ex: ORD-..." />

    <label class="muted">Message</label>
    <textarea id="supportMsg" rows="6" placeholder="Explique ton message..."></textarea>

    <button class="btn" onclick="sendSupport()">Envoyer (WhatsApp)</button>
    <button class="btn ghost" onclick="go('home')">‚Üê Accueil</button>
  </div>

</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const WHATSAPP_NUMBER = "33600000000"; // <-- NUMERO TEST (remplace par le tien ensuite, sans +)
  const SELLER_PIN = "0000";             // <-- Change si tu veux
  const VALIDATION_CODE = "VALID123";    // <-- Code test (le livreur te le donne). Tu pourras changer.

  // Concours: lot modifiable ici
  const CONTEST_CURRENT_PRIZE = "Lot surprise (change tous les 15 jours)";
  // Date de r√©f√©rence pour le compte √† rebours (tu peux laisser)
  const CONTEST_EPOCH = new Date("2026-01-01T00:00:00Z").getTime();
  const CONTEST_PERIOD_DAYS = 15;

  const EURO = (n) => `${n}‚Ç¨`;

  // =========================
  // DATA
  // =========================
  const DATA = {
    "69": {
      label: "Menu 69 ‚Äî Villefranche-sur-Sa√¥ne",
      pickupHours: "07:00 ‚Üí 00:00",
      deliveryInfo: "Livraison √† partir de 15h (hors horaires: commande possible, programm√©e au prochain cr√©neau)",
      categories: [
        { name: "Jaune mousseux", items: [
          { name: "10 meuje", pickup: 40, delivery: 50 },
          { name: "25 meuje", pickup: 80, delivery: 100 },
          { name: "50 meuje", pickup: 140, delivery: 160 },
          { name: "100 meuje", pickup: 220, delivery: 240 }
        ]},
        { name: "Filtre x3 exotique", items: [
          { name: "3,5 meuje", pickup: 30, delivery: 40 },
          { name: "10 meuje", pickup: 60, delivery: 70 },
          { name: "20 meuje", pickup: 110, delivery: 130 },
          { name: "50 meuje", pickup: 220, delivery: 240 },
          { name: "100 meuje", pickup: 400, delivery: 430 }
        ]},
        { name: "Menu coco", items: [
          { name: "1 meuje", pickup: 50, delivery: 60 },
          { name: "2 meuje", pickup: 90, delivery: 100 },
          { name: "5 meuje", pickup: 200, delivery: 220 },
          { name: "10 meuje", pickup: 350, delivery: 370 }
        ]}
      ]
    },
    "71": {
      label: "Menu 71 ‚Äî M√¢con",
      pickupHours: "07:00 ‚Üí 00:00",
      deliveryInfo: "Tourn√©es : 16h / 19h / 21h30 ‚Ä¢ Hors tourn√©e +60‚Ç¨ (m√™me hors horaires)",
      categories: [
        { name: "Jaune mousseux", items: [
          { name: "10 meuje", pickup: 50, delivery: 60 },
          { name: "25 meuje", pickup: 100, delivery: 110 },
          { name: "50 meuje", pickup: 150, delivery: 180 },
          { name: "100 meuje", pickup: 230, delivery: 260 }
        ]},
        { name: "Filtre x3 exotique", items: [
          { name: "3,5 meuje", pickup: 30, delivery: 40 },
          { name: "10 meuje", pickup: 60, delivery: 80 },
          { name: "20 meuje", pickup: 110, delivery: 120 },
          { name: "50 meuje", pickup: 230, delivery: 250 },
          { name: "100 meuje", pickup: 420, delivery: 450 }
        ]},
        { name: "Menu coco", items: [
          { name: "1 meuje", pickup: 50, delivery: 60 },
          { name: "2 meuje", pickup: 90, delivery: 120 },
          { name: "5 meuje", pickup: 200, delivery: 220 },
          { name: "10 meuje", pickup: 350, delivery: 380 }
        ]}
      ]
    }
  };

  // =========================
  // NAV
  // =========================
  const SECTIONS = ["home","stepSector","stepRubric","stepDeliveryOptions","stepPostalOptions","stepMenu","stepSummary","wheel","referral","contest","postal","apply","support"];
  function hideAll(){
    SECTIONS.forEach(id => document.getElementById(id).classList.add("hidden"));
  }
  function go(id){
    hideAll();
    document.getElementById(id).classList.remove("hidden");
    if(id === "referral") renderReferral();
    if(id === "contest") renderContest();
  }

  // =========================
  // STATE
  // =========================
  let sector = null;          // "69" | "71"
  let mode = null;            // "pickup" | "delivery" | "postal"
  let activeCat = 0;
  let deliveryTour = null;    // "16:00" | "19:00" | "21:30" | null
  let premium = false;        // hors tourn√©e +60 (only 71 delivery)
  let currentOrderId = null;

  // cart key = `${catIdx}:${itemIdx}` => qty
  const cart = new Map();

  // refs
  const stepRubric = document.getElementById("stepRubric");
  const stepDeliveryOptions = document.getElementById("stepDeliveryOptions");
  const stepPostalOptions = document.getElementById("stepPostalOptions");
  const stepMenu = document.getElementById("stepMenu");
  const stepSummary = document.getElementById("stepSummary");

  const rubricTitle = document.getElementById("rubricTitle");
  const rubricInfo = document.getElementById("rubricInfo");
  const pillPickup = document.getElementById("pillPickup");
  const pillDelivery = document.getElementById("pillDelivery");
  const pillPostal = document.getElementById("pillPostal");

  const menuTitle = document.getElementById("menuTitle");
  const categoryRow = document.getElementById("categoryRow");
  const itemsList = document.getElementById("itemsList");
  const subtotalEl = document.getElementById("subtotal");
  const totalEl = document.getElementById("total");
  const premiumRow = document.getElementById("premiumRow");

  const delivery71Tours = document.getElementById("delivery71Tours");
  const premiumPill = document.getElementById("premiumPill");
  const addrEl = document.getElementById("address");
  const noteEl = document.getElementById("note");

  const postalAddrEl = document.getElementById("postalAddress");
  const postalPhoneEl = document.getElementById("postalPhone");
  const postalNoteEl = document.getElementById("postalNote");

  // Summary refs
  const sumOrderId = document.getElementById("sumOrderId");
  const sumSector = document.getElementById("sumSector");
  const sumMode = document.getElementById("sumMode");
  const sumItems = document.getElementById("sumItems");
  const sumSubtotal = document.getElementById("sumSubtotal");
  const sumTotal = document.getElementById("sumTotal");
  const sumPremiumFeeRow = document.getElementById("sumPremiumFeeRow");
  const sumPremiumFee = document.getElementById("sumPremiumFee");

  const sumDeliveryBlock = document.getElementById("sumDeliveryBlock");
  const sumAddress = document.getElementById("sumAddress");
  const sumNote = document.getElementById("sumNote");
  const sumTourRow = document.getElementById("sumTourRow");
  const sumTour = document.getElementById("sumTour");
  const sumPremiumRow = document.getElementById("sumPremiumRow");

  const sumPostalBlock = document.getElementById("sumPostalBlock");
  const sumPostalAddress = document.getElementById("sumPostalAddress");
  const sumPostalPhone = document.getElementById("sumPostalPhone");
  const sumPostalNote = document.getElementById("sumPostalNote");

  function setActivePill(el, on){ el.classList.toggle("active", !!on); }
  function clearToursUI(){
    ["tour16","tour19","tour2130"].forEach(id => document.getElementById(id).classList.remove("active"));
    premiumPill.classList.remove("active");
  }

  function selectSector(s){
    sector = s;
    mode = null;
    activeCat = 0;
    deliveryTour = null;
    premium = false;
    cart.clear();
    addrEl.value = ""; noteEl.value = "";
    postalAddrEl.value = ""; postalPhoneEl.value = ""; postalNoteEl.value = "";
    clearToursUI();

    hideAll();
    stepRubric.classList.remove("hidden");

    rubricTitle.textContent = DATA[sector].label;
    rubricInfo.innerHTML =
      `üè¢ Sur place : ${DATA[sector].pickupHours}<br/>` +
      `üöò ${DATA[sector].deliveryInfo}`;
    setActivePill(pillPickup, false);
    setActivePill(pillDelivery, false);
    setActivePill(pillPostal, false);
  }

  function selectMode(m){
    mode = m;
    setActivePill(pillPickup, mode === "pickup");
    setActivePill(pillDelivery, mode === "delivery");
    setActivePill(pillPostal, mode === "postal");

    if(mode === "delivery"){
      hideAll();
      stepDeliveryOptions.classList.remove("hidden");
      delivery71Tours.classList.toggle("hidden", sector !== "71");
      if(sector !== "71"){
        deliveryTour = null;
        premium = false;
      } else {
        deliveryTour = deliveryTour || "16:00";
        selectTour(deliveryTour);
      }
    } else if(mode === "postal"){
      hideAll();
      stepPostalOptions.classList.remove("hidden");
    } else {
      goToMenu();
    }
  }

  function backToRubric(){
    hideAll();
    stepRubric.classList.remove("hidden");
  }

  function selectTour(t){
    if(sector !== "71") return;
    deliveryTour = t;
    clearToursUI();
    if(t === "16:00") document.getElementById("tour16").classList.add("active");
    if(t === "19:00") document.getElementById("tour19").classList.add("active");
    if(t === "21:30") document.getElementById("tour2130").classList.add("active");
    if(premium) premiumPill.classList.add("active");
  }

  function togglePremium(){
    if(sector !== "71" || mode !== "delivery") return;
    premium = !premium;
    premiumPill.classList.toggle("active", premium);
  }

  function goToMenu(){
    if(!sector || !mode){
      alert("Choisis un secteur et un mode.");
      return;
    }

    if(mode === "delivery"){
      const addr = (addrEl.value || "").trim();
      if(!addr){
        alert("Adresse obligatoire pour la livraison.");
        return;
      }
      if(sector === "71" && !deliveryTour && !premium){
        alert("Choisis une tourn√©e (ou hors tourn√©e).");
        return;
      }
    }

    if(mode === "postal"){
      const pa = (postalAddrEl.value || "").trim();
      if(!pa){
        alert("Adresse postale obligatoire.");
        return;
      }
    }

    hideAll();
    stepMenu.classList.remove("hidden");
    renderMenu();
  }

  function backFromMenu(){
    if(mode === "delivery"){
      hideAll(); stepDeliveryOptions.classList.remove("hidden");
    } else if(mode === "postal"){
      hideAll(); stepPostalOptions.classList.remove("hidden");
    } else {
      hideAll(); stepRubric.classList.remove("hidden");
    }
  }

  function clearCart(){
    cart.clear();
    renderMenu();
  }

  function renderMenu(){
    const sec = DATA[sector];
    menuTitle.textContent = `${sec.label} ‚Äî ${mode === "pickup" ? "Sur place" : (mode === "delivery" ? "Livraison" : "Envoi postal")}`;

    const premFee = (sector === "71" && mode === "delivery" && premium) ? 60 : 0;
    premiumRow.classList.toggle("hidden", premFee === 0);

    categoryRow.innerHTML = "";
    sec.categories.forEach((c, idx) => {
      const p = document.createElement("div");
      p.className = "pill" + (idx === activeCat ? " active" : "");
      p.textContent = c.name;
      p.onclick = () => { activeCat = idx; renderMenu(); };
      categoryRow.appendChild(p);
    });

    itemsList.innerHTML = "";
    const cat = sec.categories[activeCat];
    cat.items.forEach((it, itemIdx) => {
      const key = `${activeCat}:${itemIdx}`;
      const qty = cart.get(key) || 0;
      const price = (mode === "pickup") ? it.pickup : it.delivery; // postal uses delivery price

      const row = document.createElement("div");
      row.className = "item";

      const left = document.createElement("div");
      left.innerHTML = `<div class="name">${it.name}</div><div class="price">${EURO(price)}</div>`;

      const right = document.createElement("div");
      right.className = "qty";

      const minus = document.createElement("button");
      minus.className = "qbtn";
      minus.textContent = "‚àí";
      minus.onclick = () => {
        const q = cart.get(key) || 0;
        if(q <= 0) return;
        if(q === 1) cart.delete(key);
        else cart.set(key, q - 1);
        renderMenu();
      };

      const num = document.createElement("div");
      num.className = "qnum";
      num.textContent = qty;

      const plus = document.createElement("button");
      plus.className = "qbtn";
      plus.textContent = "+";
      plus.onclick = () => {
        const q = cart.get(key) || 0;
        cart.set(key, q + 1);
        renderMenu();
      };

      right.appendChild(minus);
      right.appendChild(num);
      right.appendChild(plus);

      row.appendChild(left);
      row.appendChild(right);
      itemsList.appendChild(row);
    });

    const sub = computeSubtotal();
    const prem = (sector === "71" && mode === "delivery" && premium) ? 60 : 0;
    subtotalEl.textContent = EURO(sub);
    totalEl.textContent = EURO(sub + prem);
  }

  function computeSubtotal(){
    const sec = DATA[sector];
    let sum = 0;
    for(const [key, qty] of cart.entries()){
      const [cIdx, iIdx] = key.split(":").map(Number);
      const item = sec.categories[cIdx].items[iIdx];
      const price = (mode === "pickup") ? item.pickup : item.delivery;
      sum += price * qty;
    }
    return sum;
  }

  function buildOrderPayload(){
    const sec = DATA[sector];
    const sub = computeSubtotal();
    const premFee = (sector === "71" && mode === "delivery" && premium) ? 60 : 0;
    const total = sub + premFee;

    const items = [];
    for(const [key, qty] of cart.entries()){
      const [cIdx, iIdx] = key.split(":").map(Number);
      const cat = sec.categories[cIdx];
      const item = cat.items[iIdx];
      const unit = (mode === "pickup") ? item.pickup : item.delivery;
      items.push({
        cat: cat.name,
        name: item.name,
        qty,
        unit,
        line: unit * qty
      });
    }

    const refCode = (document.getElementById("referrerCode").value || "").trim();

    const payload = {
      orderId: currentOrderId,
      sector,
      sectorLabel: sec.label,
      mode,
      delivery: {
        tour: (sector === "71" && mode === "delivery") ? (premium ? null : (deliveryTour || null)) : null,
        premium: (sector === "71" && mode === "delivery") ? premium : false,
        premiumFee: premFee,
        address: (mode === "delivery") ? (addrEl.value || "").trim() : "",
        note: (mode === "delivery") ? (noteEl.value || "").trim() : ""
      },
      postal: {
        address: (mode === "postal") ? (postalAddrEl.value || "").trim() : "",
        phone: (mode === "postal") ? (postalPhoneEl.value || "").trim() : "",
        note: (mode === "postal") ? (postalNoteEl.value || "").trim() : ""
      },
      referral: {
        referrerCode: refCode || ""
      },
      pricing: {
        currency: "EUR",
        subtotal: sub,
        premiumFee: premFee,
        totalWithoutDistance: total,
        distanceRule: "10‚Ç¨/15km (calcul vendeur)",
        extraRule: "La direction peut ajouter des frais selon km"
      },
      payment: "main_propre",
      items,
      createdAt: new Date().toISOString()
    };

    return payload;
  }

  function goToSummary(){
    const sub = computeSubtotal();
    if(sub <= 0){
      alert("Ajoute au moins un produit.");
      return;
    }

    // re-check required fields
    if(mode === "delivery"){
      if(!((addrEl.value || "").trim())){
        alert("Adresse obligatoire pour la livraison.");
        return;
      }
    }
    if(mode === "postal"){
      if(!((postalAddrEl.value || "").trim())){
        alert("Adresse postale obligatoire.");
        return;
      }
    }

    currentOrderId = `ORD-${Date.now()}`;

    const payload = buildOrderPayload();

    // Fill summary UI
    sumOrderId.textContent = payload.orderId;
    sumSector.textContent = payload.sectorLabel;
    sumMode.textContent =
      (payload.mode === "pickup") ? "Sur place" :
      (payload.mode === "delivery") ? "Livraison" : "Envoi postal";

    // Items
    sumItems.innerHTML = "";
    payload.items.forEach(it => {
      const div = document.createElement("div");
      div.className = "sumrow";
      div.innerHTML = `<span class="muted">${it.name} x${it.qty}</span><strong>${EURO(it.line)}</strong>`;
      sumItems.appendChild(div);
    });

    // Totals
    sumSubtotal.textContent = EURO(payload.pricing.subtotal);
    sumPremiumFeeRow.style.display = (payload.pricing.premiumFee > 0) ? "flex" : "none";
    sumPremiumFee.textContent = EURO(payload.pricing.premiumFee);
    sumTotal.textContent = EURO(payload.pricing.totalWithoutDistance);

    // Delivery block
    if(payload.mode === "delivery"){
      sumDeliveryBlock.classList.remove("hidden");
      sumPostalBlock.classList.add("hidden");

      sumAddress.textContent = payload.delivery.address || "‚Äî";
      sumNote.textContent = payload.delivery.note || "‚Äî";

      const showTour = (payload.sector === "71" && !payload.delivery.premium);
      sumTourRow.style.display = showTour ? "flex" : "none";
      sumTour.textContent = showTour ? (payload.delivery.tour || "‚Äî") : "‚Äî";

      sumPremiumRow.style.display = (payload.sector === "71" && payload.delivery.premium) ? "flex" : "none";
    } else if(payload.mode === "postal"){
      sumDeliveryBlock.classList.add("hidden");
      sumPostalBlock.classList.remove("hidden");

      sumPostalAddress.textContent = payload.postal.address || "‚Äî";
      sumPostalPhone.textContent = payload.postal.phone || "‚Äî";
      sumPostalNote.textContent = payload.postal.note || "‚Äî";
    } else {
      sumDeliveryBlock.classList.add("hidden");
      sumPostalBlock.classList.add("hidden");
    }

    // Store latest payload for confirm
    localStorage.setItem("lastOrderPayload", JSON.stringify(payload));

    hideAll();
    stepSummary.classList.remove("hidden");
  }

  function buildWhatsAppMessage(payload){
    const lines = [];
    lines.push("‚úÖ NOUVELLE COMMANDE");
    lines.push("");
    lines.push(`ID : ${payload.orderId}`);
    lines.push(`Secteur : ${payload.sectorLabel}`);
    lines.push(`Mode : ${payload.mode === "pickup" ? "Sur place" : payload.mode === "delivery" ? "Livraison" : "Envoi postal"}`);
    lines.push("");

    if(payload.mode === "delivery"){
      if(payload.sector === "71"){
        if(payload.delivery.premium){
          lines.push("‚òÖ Hors tourn√©e : OUI (+60‚Ç¨)");
        } else {
          lines.push(`Tourn√©e : ${payload.delivery.tour || "‚Äî"}`);
        }
      }
      lines.push("");
      lines.push("Adresse :");
      lines.push(payload.delivery.address || "‚Äî");
      if(payload.delivery.note){
        lines.push("");
        lines.push(`Note : ${payload.delivery.note}`);
      }
      lines.push("");
    }

    if(payload.mode === "postal"){
      lines.push("üì¶ Envoi postal");
      lines.push("Adresse :");
      lines.push(payload.postal.address || "‚Äî");
      if(payload.postal.phone) lines.push(`T√©l√©phone : ${payload.postal.phone}`);
      if(payload.postal.note) lines.push(`Note : ${payload.postal.note}`);
      lines.push("");
    }

    lines.push("Produits :");
    payload.items.forEach(it => {
      lines.push(`- ${it.name} x${it.qty} = ${it.line}‚Ç¨`);
    });

    lines.push("");
    lines.push(`Sous-total : ${payload.pricing.subtotal}‚Ç¨`);
    if(payload.pricing.premiumFee > 0) lines.push(`Hors tourn√©e : +${payload.pricing.premiumFee}‚Ç¨`);
    lines.push(`TOTAL (hors distance) : ${payload.pricing.totalWithoutDistance}‚Ç¨`);
    lines.push(`Frais distance : ${payload.pricing.distanceRule}`);
    lines.push("");
    if(payload.referral?.referrerCode){
      lines.push(`Code parrain : ${payload.referral.referrerCode}`);
      lines.push("");
    }
    lines.push("Paiement : main propre");
    lines.push("");
    lines.push("üé∞ ROUE : gain valable uniquement apr√®s validation r√©elle du livreur.");
    lines.push("Sans validation, aucun gain ne sera pris en compte.");

    return lines.join("\n");
  }

  function confirmToWhatsApp(){
    const raw = localStorage.getItem("lastOrderPayload");
    if(!raw){
      alert("Aucune commande trouv√©e.");
      return;
    }
    const payload = JSON.parse(raw);

    const msg = buildWhatsAppMessage(payload);

    // On sauvegarde l‚Äôheure de ‚Äúcommande envoy√©e‚Äù c√¥t√© site (√ßa ne prouve pas l‚Äôenvoi, mais aide au flow)
    localStorage.setItem("lastOrderId", payload.orderId);
    localStorage.setItem("lastOrderTs", String(Date.now()));

    // Redirection WhatsApp (plus fiable que window.open)
    window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
  }

  // =========================
  // WHEEL (1 / week + validation code)
  // =========================
  function makeWinCode(prefix="WIN"){
    const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
    let s = "";
    for(let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return `${prefix}-${s}`;
  }

  function canSpinThisWeek(){
    const last = Number(localStorage.getItem("wheel:lastSpinTs") || "0");
    if(!last) return true;
    const now = Date.now();
    return (now - last) >= 7*24*60*60*1000;
  }

  function weightedPick(prizes){
    const total = prizes.reduce((s,x)=>s+x.p,0);
    let r = Math.random()*total;
    for(const x of prizes){
      r -= x.p;
      if(r <= 0) return x;
    }
    return prizes[prizes.length-1];
  }

  function spinWheel(){
    const code = (document.getElementById("wheelCode").value || "").trim();
    const msgEl = document.getElementById("wheelMsg");
    const codeEl = document.getElementById("wheelWinCode");

    msgEl.textContent = "";
    codeEl.textContent = "";

    if(!canSpinThisWeek()){
      msgEl.textContent = "‚õî D√©j√† jou√© cette semaine. Reviens plus tard.";
      return;
    }

    if(code !== VALIDATION_CODE){
      msgEl.textContent = "‚ùå Code invalide. Attends la validation du livreur.";
      return;
    }

    // Probabilit√©s internes (non affich√©es)
    const prizes = [
      { id:"WIN_100_FILTER", label:"üéÅ Gagn√© : 100 meuje filtre", p:0.05 },
      { id:"WIN_90_OFF",     label:"üéÅ Gagn√© : -90% sur tout le catalogue", p:0.05 },
      { id:"WIN_FREE_DEL",   label:"üéÅ Gagn√© : Livraison gratuite", p:10.0 },
      { id:"WIN_STARTER",    label:"üéÅ Gagn√© : Starter pack (feuille + briquet + jeux √† gratter)", p:25.0 },
      { id:"LOSE",           label:"üòÖ Pas gagn√© cette fois. Merci quand m√™me !", p:64.9 }
    ];

    const result = weightedPick(prizes);
    const winCode = (result.id === "LOSE") ? "" : makeWinCode("WIN");

    localStorage.setItem("wheel:lastSpinTs", String(Date.now()));
    localStorage.setItem("wheel:lastPrize", result.id);
    localStorage.setItem("wheel:lastWinCode", winCode);

    msgEl.textContent = result.label + " ‚úÖ";
    codeEl.textContent = winCode ? `Code : ${winCode} (√† v√©rifier √† la remise)` : "Gain : aucun";
  }

  // =========================
  // REFERRAL (local + seller validation)
  // =========================
  function ensureMyRefCode(){
    let code = localStorage.getItem("ref:myCode");
    if(!code){
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let s="";
      for(let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
      code = `REF-${s}`;
      localStorage.setItem("ref:myCode", code);
    }
    return code;
  }

  function getRefCount(){
    return Number(localStorage.getItem("ref:count") || "0");
  }

  function setRefCount(n){
    localStorage.setItem("ref:count", String(n));
  }

  function renderReferral(){
    document.getElementById("myRefCode").textContent = ensureMyRefCode();
    const c = getRefCount();
    document.getElementById("refCount").textContent = String(c);

    let status = "";
    if(c >= 10) status = "‚úÖ Palier atteint : -100‚Ç¨";
    else if(c >= 5) status = "‚úÖ Palier atteint : -30‚Ç¨ (prochain : 10 ‚Üí -100‚Ç¨)";
    else if(c >= 3) status = "‚úÖ Palier atteint : -20‚Ç¨ (prochain : 5 ‚Üí -30‚Ç¨)";
    else status = `Encore ${3-c} filleul(s) pour d√©bloquer -20‚Ç¨`;
    document.getElementById("refStatus").textContent = status;
  }

  function shareReferral(){
    const code = ensureMyRefCode();
    const link = window.location.href;
    const text =
`üî• Nouveau concept
Viens voir le menu : ${link}

Code parrain : ${code}
(√† mettre dans la commande)`;
    window.location.href = `https://wa.me/?text=${encodeURIComponent(text)}`;
  }

  function sellerAddReferral(){
    const pin = (document.getElementById("sellerPin").value || "").trim();
    if(pin !== SELLER_PIN){
      alert("PIN vendeur incorrect.");
      return;
    }
    const c = getRefCount() + 1;
    setRefCount(c);
    document.getElementById("sellerPin").value = "";
    renderReferral();
    alert("‚úÖ 1 filleul valid√© ajout√©.");
  }

  // =========================
  // CONTEST (15 days countdown)
  // =========================
  function renderContest(){
    document.getElementById("contestPrize").textContent = CONTEST_CURRENT_PRIZE;

    const now = Date.now();
    const periodMs = CONTEST_PERIOD_DAYS * 24*60*60*1000;
    const elapsed = now - CONTEST_EPOCH;
    const next = CONTEST_EPOCH + (Math.floor(elapsed / periodMs) + 1) * periodMs;
    const diff = Math.max(0, next - now);

    const days = Math.floor(diff / (24*60*60*1000));
    const hrs = Math.floor((diff % (24*60*60*1000)) / (60*60*1000));
    const mins = Math.floor((diff % (60*60*1000)) / (60*1000));

    document.getElementById("contestCountdown").textContent = `${days}j ${hrs}h ${mins}m`;
  }

  function sendContest(){
    const link = (document.getElementById("contestLink").value || "").trim();
    const platform = document.getElementById("contestPlatform").value;
    const user = (document.getElementById("contestUser").value || "").trim();

    if(!link){
      alert("Mets le lien de ta vid√©o.");
      return;
    }

    const msg =
`üèÜ PARTICIPATION CONCOURS

Plateforme : ${platform}
Pseudo : ${user || "‚Äî"}
Lien : ${link}

(Le concours est permanent. Tirage tous les ${CONTEST_PERIOD_DAYS} jours.)`;

    window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
  }

  // =========================
  // APPLY
  // =========================
  let applyKind = "shop";
  function applyType(kind){
    applyKind = kind;
    document.getElementById("applyShopPill").classList.toggle("active", kind === "shop");
    document.getElementById("applyDeliveryPill").classList.toggle("active", kind === "delivery");
  }

  function sendApply(){
    const name = (document.getElementById("applyName").value || "").trim();
    const city = (document.getElementById("applyCity").value || "").trim();
    const avail = (document.getElementById("applyAvail").value || "").trim();
    const msg = (document.getElementById("applyMsg").value || "").trim();

    if(!name || !city || !msg){
      alert("Remplis au minimum : Nom, Ville, Message.");
      return;
    }

    const title = (applyKind === "shop") ? "üè™ CANDIDATURE OUVRIR SECTEUR" : "üöö CANDIDATURE LIVREUR";
    const text =
`${title}

Nom : ${name}
Ville/D√©pt : ${city}
Dispos : ${avail || "‚Äî"}

Message :
${msg}`;

    window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  }

  // =========================
  // SUPPORT
  // =========================
  function sendSupport(){
    const type = document.getElementById("supportType").value;
    const oid = (document.getElementById("supportOrderId").value || "").trim();
    const msg = (document.getElementById("supportMsg").value || "").trim();

    if(!msg){
      alert("√âcris ton message.");
      return;
    }

    const text =
`üì© SERVICE CLIENT

Type : ${type}
ID commande : ${oid || "‚Äî"}

Message :
${msg}`;

    window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  }

  // =========================
  // SHARE SITE
  // =========================
  function shareSite(){
    const link = window.location.href;
    const code = ensureMyRefCode();
    const text =
`D√©couvre le menu :
${link}

Code parrain : ${code}`;
    window.location.href = `https://wa.me/?text=${encodeURIComponent(text)}`;
  }

  // Init home
  go("home");
</script>

</body>
</html>
